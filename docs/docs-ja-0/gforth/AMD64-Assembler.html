<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>AMD64 Assembler (Gforth マニュアル)</title>

<meta name="description" content="AMD64 Assembler (Gforth マニュアル)">
<meta name="keywords" content="AMD64 Assembler (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Assembler-and-Code-Words.html" rel="up" title="Assembler and Code Words">
<link href="Alpha-Assembler.html" rel="next" title="Alpha Assembler">
<link href="386-Assembler.html" rel="prev" title="386 Assembler">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsection" id="AMD64-Assembler">
<div class="header">
<p>
Next: <a href="Alpha-Assembler.html" accesskey="n" rel="next">Alpha Assembler</a>, Previous: <a href="386-Assembler.html" accesskey="p" rel="prev">386 Assembler</a>, Up: <a href="Assembler-and-Code-Words.html" accesskey="u" rel="up">Assembler and Code Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="AMD64-_0028x86_005f64_0029-Assembler"></span><h4 class="subsection">6.29.5 AMD64 (x86_64) Assembler</h4>

<p>AMD64 アセンブラーは、 386 アセンブラーをわずかに変更したバージョンであり、 構文の大部分を共有しています。  2 つの新しい接頭辞
<code>.q</code> と <code>.qa</code> が、 それぞれ 64 ビット・サイズのオペランドやアドレスを選択するために提供されています。  64
ビット・サイズがデフォルトであるため、 通常は他のプレフィックスを使用するだけで済みます。  また、 追加のレジスター・オペランド <code>R8</code>
～ <code>R15</code> もあります。
</p>
<p>レジスターには「e」または「r」プレフィックスがありません。 64 ビット・モードでも、 <code>rax</code> は <code>ax</code> と呼ばれます。
すべてのレジスターで最下位バイトを参照するために追加のレジスター・オペランドを使用できます: <code>R8L</code> 〜 -<code>R15L</code>,
<code>SPL</code>,  <code>BPL</code>,  <code>SIL</code>,  <code>DIL</code>
</p>
<p>Linux-AMD64 の呼び出し規則では、 最初の 6 つの整数パラメーターを rdi, rsi, rdx, rcx, r8, r9 で渡し、 結果を
rax , rdx で返します。 最初の 8 つの FP パラメータを xmm0 ～ xmm7 に渡し、 FP 結果を xmm0 ～ xmm1
に返します。  したがって、<code>abi-code</code> ワードは、 <code>di</code> でデータ・スタック・ポインターを取得し、 <code>si</code>
で FP スタック・ポインターのアドレスを取得し、 リターン時は <code>ax</code> にデータ・スタック ポインターをセットします。
呼び出し元が保存する他のレジスターは、 r10, r11 xmm8 ～ xmm15 です。 この呼び出し規約は、 Microsoft 以外の他の OS
でも使用されていると報告されています。
</p>
<p>Windows x64 は、 最初の 4 つの整数パラメータを rcx, rdx, r8, r9 に渡し、 整数の結果を rax に返します。
他の、呼び出し元保存レジスターは r10 と r11 です。
</p>
<p><a href="https://uclibc.org/docs/psABI-x86_64.pdf">https://uclibc.org/docs/psABI-x86_64.pdf</a> の  21ページによると、 Linux
プラットフォームでは、 レジスター AX CX DX SI DI R8 R9 R10 R11 が自由(scratch)に使えます。
</p>
<p>AMD64 のアドレッシング・モードは以下のとおりです:
</p>
<div class="example">
<pre class="example">\ ご注意: ワード A を実行すると、レジスターが初期化されていないため、 メモリー・エラーが発生します ;-)
ABI-CODE A  ( -- )
    500        #               AX  MOV     \ immediate
        DX              AX  MOV     \ register
        200             AX  MOV     \ direct addressing
        DX  )           AX  MOV     \ indirect addressing
    40  DX  D)          AX  MOV     \ base with displacement
        DX  CX      I)  AX  MOV     \ scaled index
        DX  CX  *4  I)  AX  MOV     \ scaled index
    40  DX  CX  *4  DI) AX  MOV     \ scaled index with displacement

        DI              AX  MOV     \ SP Out := SP in
                            RET
END-CODE
</pre></div>

<p>AMD64 <code>abi-code</code> ワードの例をいくつか示します:
</p>
<div class="example">
<pre class="example">abi-code my+  ( n1 n2 -- n3 )
\ SP passed in di, returned in ax,  address of FP passed in si
8 di d) ax lea        \ compute new sp in result reg ( 結果として di+8 → ax つまり drop と同じ)
di )    dx mov        \ get old tos ( [di] つまり n2   → dx )
dx    ax ) add        \ add to new tos ( dx + [ax] → [ax]
ret
end-code
</pre></div>

<div class="example">
<pre class="example">\ Do nothing
ABI-CODE aNOP  ( -- )
       DI  )       AX      LEA          \ SP out := SP in  
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">\ Drop TOS
ABI-CODE aDROP  ( n -- )
   8   DI  D)      AX      LEA          \ SPout := SPin - 1
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">\ Push 5 on the data stack
ABI-CODE aFIVE   ( -- 5 )
   -8  DI  D)      AX      LEA          \ SPout := SPin + 1
   5   #           AX  )   MOV          \ TOS := 5
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">\ Push 10 and 20 into data stack
ABI-CODE aTOS2  ( -- n n )
   -16 DI  D)      AX      LEA          \ SPout := SPin + 2
   10  #       8   AX  D)  MOV          \ TOS - 1 := 10
   20  #           AX  )   MOV          \ TOS := 20
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">\ Get Time Stamp Counter as two 32 bit integers
\ The TSC is incremented every CPU clock pulse
ABI-CODE aRDTSC   ( -- TSCl TSCh )
                           RDTSC        \ DX:AX := TSC
   $FFFFFFFF #     AX      AND          \ Clear upper 32 bit AX
  0xFFFFFFFF #     DX      AND          \ Clear upper 32 bit DX
       AX          R8      MOV          \ Tempory save AX
   -16 DI  D)      AX      LEA          \ SPout := SPin + 2
       R8      8   AX  D)  MOV          \ TOS-1 := saved AX = TSC low
       DX          AX  )   MOV          \ TOS := Dx = TSC high
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">\ Get Time Stamp Counter as 64 bit integer
ABI-CODE RDTSC   ( -- TSC )
                           RDTSC        \ DX:AX := TSC
   $FFFFFFFF #     AX      AND          \ Clear upper 32 bit AX
   32  #           DX      SHL          \ Move lower 32 bit DX to upper 32 bit
       AX          DX      OR           \ Combine AX wit DX in DX
   -8  DI  D)      AX      LEA          \ SPout := SPin + 1
       DX          AX  )   MOV          \ TOS := DX
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">VARIABLE V

\ Assign 4 to variable V
ABI-CODE V=4 ( -- )
       BX                  PUSH         \ Save BX, used by gforth
   V   #           BX      MOV          \ BX := address of V
   4   #           BX )    MOV          \ Write 4 to V
       BX                  POP          \ Restore BX
       DI  )       AX      LEA          \ SPout := SPin
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">VARIABLE V

\ Assign 5 to variable V
ABI-CODE V=5 ( -- )
   V   #           CX      MOV          \ CX := address of V
   5   #           CX )    MOV          \ Write 5 to V
   DI )            AX      LEA          \ SPout := SPin
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">ABI-CODE TEST2  ( -- n n )
   -16 DI  D)  AX          LEA          \ SPout := SPin + 2
   5   #       CX          MOV          \ CX := 5
   5   #       CX          CMP
   0= IF
       1   #   8   AX  D)      MOV      \ If CX = 5 then TOS - 1 := 1  &lt;--
   ELSE
       2   #   8   AX  D)      MOV      \ else TOS - 1 := 2
   THEN
   6   #       CX          CMP
   0= IF
       3   #       AX  )       MOV      \ If CX = 6 then TOS := 3
   ELSE
       4   #       AX  )       MOV      \ else TOS := 4  &lt;--
   THEN
                           RET
END-CODE
</pre></div>


<div class="example">
<pre class="example">\ Do four loops. Expect : ( 4 3 2 1 -- )
ABI-CODE LOOP4  ( -- n n n n )
       DI          AX      MOV          \ SPout := SPin
   4   #           DX      MOV          \ DX := 4  loop counter
   BEGIN
       8   #           AX      SUB      \ SP := SP + 1
           DX          AX  )   MOV      \ TOS := DX
       1   #           DX      SUB      \ DX := DX - 1
   0= UNTIL
                           RET
END-CODE
</pre></div>

<p>以下は、FP 値を扱う AMD64 用の例です:
</p>
<div class="example">
<pre class="example">abi-code my-f+  ( r1 r2 -- r )
\ SP passed in di, returned in ax,  address of FP passed in si
si )       dx mov         \ load fp
8 dx d)  xmm0 movsd       \ r2
dx )     xmm0 addsd       \ r1+r2
xmm0  8 dx d) movsd       \ store r
8 #      si ) add         \ update fp
di         ax mov         \ sp into return reg
ret
end-code
</pre></div>

</div>
<hr>
<div class="header">
<p>
Next: <a href="Alpha-Assembler.html">Alpha Assembler</a>, Previous: <a href="386-Assembler.html">386 Assembler</a>, Up: <a href="Assembler-and-Code-Words.html">Assembler and Code Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
