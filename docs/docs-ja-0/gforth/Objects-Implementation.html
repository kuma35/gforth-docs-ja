<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Objects Implementation (Gforth マニュアル)</title>

<meta name="description" content="Objects Implementation (Gforth マニュアル)">
<meta name="keywords" content="Objects Implementation (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Objects.html" rel="up" title="Objects">
<link href="Objects-Glossary.html" rel="next" title="Objects Glossary">
<link href="Object-Interfaces.html" rel="prev" title="Object Interfaces">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsubsection" id="Objects-Implementation">
<div class="header">
<p>
Next: <a href="Objects-Glossary.html" accesskey="n" rel="next"><samp>objects.fs</samp> Glossary</a>, Previous: <a href="Object-Interfaces.html" accesskey="p" rel="prev">Object Interfaces</a>, Up: <a href="Objects.html" accesskey="u" rel="up">The <samp>objects.fs</samp> model</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="objects_002efs-Implementation"></span><h4 class="subsubsection">6.24.3.11 <samp>objects.fs</samp> Implementation</h4>
<span id="index-objects_002efs-implementation"></span>

<span id="index-object_002dmap-discussion"></span>
<p>オブジェクトは、 <code>struct...end-struct</code> で記述されたデータ構造の 1 つである、 メモリの一片です。 これには、
オブジェクトのクラスのメソッド・マップ(the method map)を指すフィールド <code>object-map</code> があります。
</p>
<span id="index-method-map"></span>
<span id="index-virtual-function-table"></span>
<p>「メソッド・マップ」(method map)<a id="DOCF33" href="#FOOT33"><sup>33</sup></a>は、 オブジェクトのクラスのメソッドの実行トークン(<i>xt</i>)を含む配列です。 各セレクターには、
メソッド・マップへのオフセットが含まれています。
</p>
<span id="index-selector-implementation_002c-class"></span>
<p><code>selector</code> は、<code>CREATE</code> と <code>DOES&gt;</code> を使用する定義ワードです。 selector
の本体にはオフセットが含まれています。 クラスのセレクターの <code>DOES&gt;</code> アクションは、 基本的には以下のとおりです:
</p>
<div class="example">
<pre class="example">( object addr ) @ over object-map @ + @ execute
</pre></div>

<p>なお、 <code>object-map</code> はオブジェクトの最初のフィールドであるため、 コードは生成されません。 ご覧のとおり、
セレクターの呼び出しには小さいけれども一定のコストがかかります。
</p>
<span id="index-current_002dinterface-discussion"></span>
<span id="index-class-implementation-and-representation"></span>
<p>クラスは基本的に <code>struct</code> とメソッド・マップを組み合わせたものです。 <code>struct</code> の場合と同様に、 クラス定義中に、
クラスのアライメントとサイズがスタックに渡されるため、 <code>field</code> をクラスのフィールドの定義にも使用できます。 ただし、
スタックにさらに多くの項目を渡すと不便になるため、 <code>class</code> はメモリ内にデータ構造を構築し、 変数
<code>current-interface</code> を通じてアクセスします。 定義が完了すると、 クラスはポインタ(たとえば、
子クラス定義のパラメータとして利用したりする)としてスタックに置かれます。
</p>
<p>新しいクラスは、 その親のアライメントとサイズ、 およびその親のメソッド・マップのコピーから始まります。 新しいフィールドを定義すると、
サイズとアライメントが拡張されます。 同様に、 新しいセレクターを定義すると、 メソッド・マップが拡張されます。 <code>overrides</code> は、
セレクターによって指定されたオフセットでメソッド・マップに新しい <i>xt</i> を保存するだけです。
</p>
<span id="index-class-binding_002c-implementation"></span>
<p>クラス結び付け(class binding)は、クラスのメソッド・マップからセレクターによって指定されたオフセットで <i>xt</i> を取得し、 それを
<code>compile,</code> で取得します(<code>[bind]</code> の場合)。
</p>
<span id="index-this-implementation"></span>
<span id="index-catch-and-this"></span>
<span id="index-this-and-catch"></span>
<p>著者は <code>this</code> を <code>value</code> として実装しました。 <code>m:...;m</code> メソッドの開始時に、 古い
<code>this</code> がリターン・スタックに保存され、 最後に復元されます。 TOS 上のオブジェクトは <code>TO this</code> で保存します。
この手法には欠点が 1 つあります。 ユーザーが <code>;m</code> 経由ではなく <code>throw</code> または <code>exit</code>
経由でメソッドを終了した場合、 <code>this</code> は復元されません(そして <code>exit</code> がクラッシュする可能性があります)。 著者は
<code>throw</code> の問題に対処するために、 <code>this</code> を保存および復元するために <code>catch</code>
を再定義しました(訳注: つまり、 &quot;objects.fs&quot; をインクルードした時に redefined
と警告が出るが、意図的に再定義してあるので無視してください)。 例外をキャッチできるワードについても全く同様に行うべきです。 <code>exit</code>
については、 単純に使用を禁止します(代わりに <code>exitm</code> があります)。
</p>
<span id="index-inst_002dvar-implementation"></span>
<p><code>inst-var</code> は <code>field</code> とまったく同じですが、 <code>DOES&gt;</code> アクションが異なります:
</p><div class="example">
<pre class="example">@ this +
</pre></div>
<p><code>inst-value</code> も同様です。
</p>
<span id="index-class-scoping-implementation"></span>
<p>各クラスは、 <code>inst-var</code> と <code>inst-value</code> で定義されたワードや、 それらの protected
されたワードを含む、 ワードリストを持っています。 また、 その親へのポインタも持っています。 <code>class</code> は、
クラスとそのすべての祖先のワードリストを検索順序スタック(the search order)にプッシュし、 <code>end-class</code>
はそれらをスタックから drop します。
</p>
<span id="index-interface-implementation"></span>
<p>インターフェイスは、 フィールドと親と protected されたワードのないクラスに似ています。 つまり、 メソッド・マップがあるだけです。
クラスがインターフェイスを実装する場合、 そのメソッド・マップにはインターフェイスのメソッド・マップへのポインターが含まれます。
マップ内の正のオフセットはクラス・メソッド用に予約されているため、 インターフェイス・マップ・ポインターは負のオフセットを持ちます。
クラス・セレクターとは異なり、 インターフェイスにはシステム全体で一意のオフセットがあります。 クラス・セレクターのオフセットは、
セレクターが利用可能な(呼び出し可能な)クラスに対してのみ一意です。
</p>
<p>この構造は、 インターフェイス・セレクターがメソッドを見つけるために、 クラス・セレクターよりも 1
つ多い間接参照を実行する必要があることを意味します。 その本体には、 クラス・メソッド・マップ内のインターフェイス・マップ・ポインター・オフセットと、
インターフェイス・メソッド・マップ内のメソッド・オフセットが含まれています。 インターフェイス・セレクターの <code>does&gt;</code> アクションは、
基本的には以下のとおりです:
</p>
<div class="example">
<pre class="example">( object selector-body )
2dup selector-interface @ ( object selector-body object interface-offset )
swap object-map @ + @ ( object selector-body map )
swap selector-offset @ + @ execute
</pre></div>

<p>ここで、 <code>object-map</code> と <code>selector-offset</code> は最初のフィールドであり、 コードは生成されません。
</p>
<p>具体的な例として、 以下のコードについて考えてみましょう: 
</p>
<div class="example">
<pre class="example">interface
  selector if1sel1
  selector if1sel2
end-interface if1

object class
  if1 implementation
  selector cl1sel1
  cell% inst-var cl1iv1

' m1 overrides construct
' m2 overrides if1sel1
' m3 overrides if1sel2
' m4 overrides cl1sel2
end-class cl1

create obj1 object dict-new drop
create obj2 cl1    dict-new drop
</pre></div>

<p>このコードで作成されたデータ構造 (<code>object</code> のデータ構造を含む) は、セル・サイズ 4 を想定して
<a href="objects-implementation.png">figure</a> に図示されています。
</p>
</div>
<div class="footnote">
<hr>
<h4 class="footnotes-heading">Footnotes</h4>

<h5><a id="FOOT33" href="#DOCF33">(33)</a></h5>
<p>「メソッド・マップ」(method map)は著者自作用語です。 C++ 用語では、
仮想関数テーブル と言います。</p>
</div>
<hr>
<div class="header">
<p>
Next: <a href="Objects-Glossary.html"><samp>objects.fs</samp> Glossary</a>, Previous: <a href="Object-Interfaces.html">Object Interfaces</a>, Up: <a href="Objects.html">The <samp>objects.fs</samp> model</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
