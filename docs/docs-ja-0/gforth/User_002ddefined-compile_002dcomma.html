<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright © 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>User-defined compile-comma (Gforth マニュアル)</title>

<meta name="description" content="User-defined compile-comma (Gforth マニュアル)">
<meta name="keywords" content="User-defined compile-comma (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="User_002ddefined-Defining-Words.html" rel="up" title="User-defined Defining Words">
<link href="Creating-from-a-prototype.html" rel="next" title="Creating from a prototype">
<link href="User_002ddefined-TO-and-DEFER_0040.html" rel="prev" title="User-defined TO and DEFER@">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
pre.format-preformatted {font-family: inherit}
span:hover a.copiable-link {visibility: visible}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsubsection-level-extent" id="User_002ddefined-compile_002dcomma">
<div class="nav-panel">
<p>
Next: <a href="Creating-from-a-prototype.html" accesskey="n" rel="next">Creating from a prototype</a>, Previous: <a href="User_002ddefined-TO-and-DEFER_0040.html" accesskey="p" rel="prev">User-defined <code class="code">to</code> and <code class="code">defer@</code></a>, Up: <a href="User_002ddefined-Defining-Words.html" accesskey="u" rel="up">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h4 class="subsubsection" id="User_002ddefined-compile_002c"><span>6.10.10.7 User-defined <code class="code">compile,</code><a class="copiable-link" href="#User_002ddefined-compile_002c"> &para;</a></span></h4>

<p>以下を使用して、 とあるワードのための <code class="code">compile,</code> の実装を変更することもできます
</p>
<a class="index-entry-id" id="index-set_002doptimizer-_0028-xt-_002d_002d-_0029-gforth_002d1_002e0"></a>
<a class="index-entry-id" id="index-set_002doptimizer"></a>
<a class="index-entry-id" id="index-set_002doptimizer-1"></a>
<div class="format">
<pre class="format-preformatted"><code class="code">set-optimizer</code> ( <i class="i">xt &ndash;  </i>) gforth-1.0 &ldquo;set-optimizer&rdquo;
</pre></div>
<p><code class="code">compile,</code> で <i class="i">xt</i> execute するように現在のワードを変更します(<code class="code">compile,</code>
に渡されたものと同じスタック内容を使用)。 注意: <code class="code">compile,</code> は <code class="code">execute</code>
とスタック内容が一致している必要があるため、 <code class="code">set-optimizer</code> は同じ振る舞いの、
より効率的な実装をインストールする場合にのみ使用しなければならないことに注意してください。
</p>

<a class="index-entry-id" id="index-opt_003a-_0028-compilation-_002d_002d-colon_002dsys2-_003b-run_002dtime-_002d_002d-nest_002dsys-_0029-gforth_002d1_002e0"></a>
<a class="index-entry-id" id="index-opt_003a"></a>
<a class="index-entry-id" id="index-opt_003a-1"></a>
<div class="format">
<pre class="format-preformatted"><code class="code">opt:</code> ( <i class="i">compilation &ndash; colon-sys2 ; run-time &ndash; nest-sys  </i>) gforth-1.0 &ldquo;opt:&rdquo;
</pre></div>
<p>名前無しのコロン定義を開始します。 完了すると、 このコロン定義は(<code class="code">opt:</code> の前の)最新のワードの <code class="code">compile,</code>
の実装になります。
</p>


<p>注意: 結果として得られる <code class="code">compile,</code> は、 依然として <code class="code">postpone literal postpone
execute</code> と同等である必要があることに注意してください。 そのため、 <code class="code">set-optimizer</code> は、
振る舞いを変更するためではなく、 効率化のために役立てるものです。  しかし、 あなたが自分の足を撃つことを妨げるものは何もありません。  あなたが
<code class="code">set-optimizer</code> を使用したときの結果と、 最初に以下を定義して使用を無効にしたときに得られる結果を比較することで、
<code class="code">set-optimizer</code> の使用が正しいかどうかを確認できます。
</p>
<div class="example">
<pre class="example-preformatted">: set-optimizer drop ;
</pre></div>

<p><code class="code">set-optimizer</code> の使用例として、 上記の <code class="code">CONSTANT</code> の定義の 1 つを以下のように拡張できます。
</p>
<div class="example">
<pre class="example-preformatted">: CONSTANT ( n &quot;name&quot; -- ; name: -- n )
  create ,
  ['] @ set-does&gt;
  [: &gt;body @ postpone literal ;] set-optimizer
;
</pre></div>

<p>唯一の変更は、 <code class="code">set-optimizer</code> 行の追加です。 あなたが定数を定義してコンパイルすると、 以下のようになります:
</p>
<div class="example">
<pre class="example-preformatted">5 constant five
: foo five ;
</pre></div>

<p><code class="code">foo</code> 内のコンパイル済み <code class="code">five</code> は、 <code class="code">five</code> の一般的な呼び出しではなく、 literal 5
とコンパイルされるようになりました。  引用(quotation)には、 <code class="code">compile,</code> と同じスタック効果があり、 それは
<code class="code">( xt -- )</code> です。  渡された xt は <code class="code">compile,</code> されたワード、 つまりこの例では <code class="code">five</code>
に属します。 この例では、 まず xt が本体アドレスに変換され、 次にその場所の値 5 が取り出され、 その値が <code class="code">postpone
literal</code> でコンパイルされます(see <a class="pxref" href="Literals.html">Literals</a>)。
</p>
<p>この <code class="code">set-optimizer</code> の使用は、 ユーザーが、 例えば <code class="code">6 ' five &gt;body !</code>
などして定数の値を変更しないことを前提としています。  <code class="code">five</code> は <code class="code">create</code> で定義されていますが、 これは
<code class="code">CONSTANT</code> の実装の詳細であり、 それを文書化しない場合、 ユーザーはそれに依存してはなりません。  また、
本体(body)が変更されないことを前提とした方法で <code class="code">set-optimizer</code> を使用する場合、 (ここで行われているように)
<code class="code">create</code> が使用されていることを文書化してはなりません。 逆に、 それを文書化する場合は、 本体の変更を処理できるように
<code class="code">compile,</code> 実装を記述する必要があります。
</p>
<p>もう一つの例は、 前述の <code class="code">fvalue</code> の例をさらに最適化したものです:
</p>
<div class="example">
<pre class="example-preformatted">: compile-fvalue-to ( xt-value-to -- )
  drop ]] &gt;body f! [[ ;
  
: fvalue-to ( r xt -- )
  &gt;body f! ;
' compile-fvalue-to set-optimizer

: fvalue ( r &quot;name&quot; -- ; name: -- r )
  create f,
  ['] f@ set-does&gt;
  [: &gt;body ]] literal f@ [[ ;] set-optimizer
  ['] fvalue-to set-to ;

5e fvalue foo
: bar foo 1e f+ to foo ;
see bar
</pre></div>

<p><code class="code">bar</code> のコードを以前の定義のコードと比較します。  ここでは、 fvalue を読み取るコード(<code class="code">fvalue</code> の
<code class="code">set-optimizer</code> より)と、 fvalue を書き込むコード(<code class="code">fvalue-to</code> に適用された
<code class="code">set-optimizer</code> より)の両方の最適化が見られます。 fvalue は(定数とは異なり)変化する可能性があるため、
(<code class="code">fvalue</code> 内部の)読み取り部分が、 アドレスと、 実行時に実行される <code class="code">f@</code> をコンパイルします。
</p>
<p><code class="code">fvalue-to</code> の場合、 <code class="code">compile,</code> の実装は基本的に、 <code class="code">fvalue</code>
によってインラインで実行されるコードをコンパイルするだけです。 <code class="code">to</code> のコンパイル機能(compilation
semantics)は、アドレスをリテラルとしてコンパイルしてから、 <code class="code">(to)</code> の実装(つまり、
<code class="code">fvalue-to</code>)をコンパイルします。 この処理では、 <code class="code">&gt;body</code> が最適化されて削除されます。
</p>
<p>実際には、 Gforth の <code class="code">fvalue</code> は、 たとえば <code class="code">+TO</code> をサポートするなど、
いくつかの追加の工夫が含まれています。
</p>
<p>注意: <code class="code">set-optimizer</code> の呼び出しは、 <code class="code">set-does&gt;</code> (または <code class="code">does&gt;</code>
の呼び出しの後に実行する必要があることに注意してください。 なぜなら、 <code class="code">set-does&gt;</code> は <code class="code">compile,</code>
の実装それ自体を上書きするからです。
</p>
<p><code class="code">fvalue-to</code> の例でわかるように、 <code class="code">set-optimizer</code> を <code class="code">constant</code> や
<code class="code">fvalue</code> のような定義ワード内ではなく、 個々のワードに適用することもできます。  この場合、 オプティマイザに渡されるワードの xt
は通常は不要であり、 <code class="code">compile-fvalue-to</code> のように <code class="code">drop</code> されます。
</p>
<p>エンジン <code class="code">gforth-itc</code> は <code class="code">compile,</code> に <code class="code">,</code> を使用するので、 そこでは
<code class="code">set-optimizer</code> は効果ありません。
</p>

</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="Creating-from-a-prototype.html">Creating from a prototype</a>, Previous: <a href="User_002ddefined-TO-and-DEFER_0040.html">User-defined <code class="code">to</code> and <code class="code">defer@</code></a>, Up: <a href="User_002ddefined-Defining-Words.html">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
