<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>User-defined compile-comma (Gforth マニュアル)</title>

<meta name="description" content="User-defined compile-comma (Gforth マニュアル)">
<meta name="keywords" content="User-defined compile-comma (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="User_002ddefined-Defining-Words.html" rel="up" title="User-defined Defining Words">
<link href="Creating-from-a-prototype.html" rel="next" title="Creating from a prototype">
<link href="User_002ddefined-TO-and-DEFER_0040.html" rel="prev" title="User-defined TO and DEFER@">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsubsection" id="User_002ddefined-compile_002dcomma">
<div class="header">
<p>
Next: <a href="Creating-from-a-prototype.html" accesskey="n" rel="next">Creating from a prototype</a>, Previous: <a href="User_002ddefined-TO-and-DEFER_0040.html" accesskey="p" rel="prev">User-defined <code>to</code> and <code>defer@</code></a>, Up: <a href="User_002ddefined-Defining-Words.html" accesskey="u" rel="up">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="User_002ddefined-compile_002c"></span><h4 class="subsubsection">6.10.10.7 User-defined <code>compile,</code></h4>

<p>以下を使用して、 とあるワードのための <code>compile,</code> の実装を変更することもできます
</p>
<span id="index-set_002doptimizer-_0028--xt-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-set_002doptimizer"></span>
<span id="index-set_002doptimizer-1"></span>
<div class="format">
<pre class="format"><code>set-optimizer</code> ( <i>xt &ndash;  </i>) gforth-1.0 &ldquo;set-optimizer&rdquo;
</pre></div>
<p><code>compile,</code> で <i>xt</i> execute するように現在のワードを変更します(<code>compile,</code>
に渡されたものと同じスタック内容を使用)。 注意: <code>compile,</code> は <code>execute</code>
とスタック内容が一致している必要があるため、 <code>set-optimizer</code> は同じ振る舞いの、
より効率的な実装をインストールする場合にのみ使用しなければならないことに注意してください。
</p>

<span id="index-opt_003a-_0028--compilation-_002d_002d-colon_002dsys2-_003b-run_002dtime-_002d_002d-nest_002dsys--_0029-gforth_002d1_002e0"></span>
<span id="index-opt_003a"></span>
<span id="index-opt_003a-1"></span>
<div class="format">
<pre class="format"><code>opt:</code> ( <i>compilation &ndash; colon-sys2 ; run-time &ndash; nest-sys  </i>) gforth-1.0 &ldquo;opt:&rdquo;
</pre></div>
<p>名前無しのコロン定義を開始します。 完了すると、 このコロン定義は(<code>opt:</code> の前の)最新のワードの <code>compile,</code>
の実装になります。
</p>


<p>注意: 結果として得られる <code>compile,</code> は、 依然として <code>postpone literal postpone
execute</code> と同等である必要があることに注意してください。 そのため、 <code>set-optimizer</code> は、
振る舞いを変更するためではなく、 効率化のために役立てるものです。  しかし、 あなたが自分の足を撃つことを妨げるものは何もありません。  あなたが
<code>set-optimizer</code> を使用したときの結果と、 最初に以下を定義して使用を無効にしたときに得られる結果を比較することで、
<code>set-optimizer</code> の使用が正しいかどうかを確認できます。
</p>
<div class="example">
<pre class="example">: set-optimizer drop ;
</pre></div>

<p><code>set-optimizer</code> の使用例として、 上記の <code>CONSTANT</code> の定義の 1 つを以下のように拡張できます。
</p>
<div class="example">
<pre class="example">: CONSTANT ( n &quot;name&quot; -- ; name: -- n )
  create ,
  ['] @ set-does&gt;
  [: &gt;body @ postpone literal ;] set-optimizer
;
</pre></div>

<p>唯一の変更は、 <code>set-optimizer</code> 行の追加です。 あなたが定数を定義してコンパイルすると、 以下のようになります:
</p>
<div class="example">
<pre class="example">5 constant five
: foo five ;
</pre></div>

<p><code>foo</code> 内のコンパイル済み <code>five</code> は、 <code>five</code> の一般的な呼び出しではなく、 literal 5
とコンパイルされるようになりました。  引用(quotation)には、 <code>compile,</code> と同じスタック効果があり、 それは
<code>( xt -- )</code> です。  渡された xt は <code>compile,</code> されたワード、 つまりこの例では <code>five</code>
に属します。 この例では、 まず xt が本文アドレスに変換され、 次にその場所の値 5 がフェッチされ、 その値が <code>postpone
literal</code> でコンパイルされます(see <a href="Literals.html">Literals</a>)。
</p>
<p>この <code>set-optimizer</code> の使用は、 ユーザーが、 例えば <code>6 ' four &gt;body !</code>
などして定数の値を変更しないことを前提としています。  <code>five</code> は <code>create</code> で定義されていますが、 これは
<code>CONSTANT</code> の実装の詳細であり、 それを文書化しない場合、 ユーザーはそれに依存してはなりません。  また、
h本体が変更されないことを前提とした方法で <code>set-optimizer</code> を使用する場合、 (ここで行われているように)
<code>create</code> が使用されていることを文書化してはなりません。 逆に、 それを文書化する場合は、 本体の変更を処理できるように
<code>compile,</code> 実装を記述する必要があります。
</p>
<p>別の例は、 上記の <code>fvalue</code> の例をさらに最適化したものです:
</p>
<div class="example">
<pre class="example">: compile-fvalue-to ( xt-value-to -- )
  drop ]] &gt;body f! [[ ;
  
: fvalue-to ( r xt -- )
  &gt;body f! ;
' compile-fvalue-to set-optimizer

: fvalue ( r &quot;name&quot; -- ; name: -- r )
  create f,
  ['] f@ set-does&gt;
  [: &gt;body ]] literal f@ [[ ;] set-optimizer
  ['] fvalue-to set-to ;

5e fvalue foo
: bar foo 1e f+ to foo ;
see bar
</pre></div>

<p><code>bar</code> のコードを以前の定義のコードと比較します。  ここでは、 fvalue を読み取るコード(<code>fvalue</code> の
<code>set-optimizer</code> より)と、 fvalue を書き込むコード(<code>fvalue-to</code> に適用された
<code>set-optimizer</code> より)の両方の最適化が見られます。 fvalue は(定数とは異なり)変化する可能性があるため、
(<code>fvalue</code> 内部の)読み取り部分が、 アドレスと、 実行時に実行される <code>f@</code> をコンパイルします。
</p>
<p><code>fvalue-to</code> の場合、 <code>compile,</code> の実装は基本的に、 <code>fvalue</code>
によってインラインで実行されるコードをコンパイルするだけです。 <code>to</code> のコンパイル機能(compilation
semantics)は、アドレスをリテラルとしてコンパイルしてから、 <code>(to)</code> の実装(つまり、
<code>fvalue-to</code>)をコンパイルします。 この処理では、 <code>&gt;body</code> が最適化されて削除されます。
</p>
<p>実際には、 Gforth の <code>fvalue</code> は、 たとえば <code>+TO</code> をサポートするなど、
いくつかの追加の工夫が含まれています。
</p>
<p>注意: <code>set-optimizer</code> の呼び出しは、 <code>set-does&gt;</code> (または <code>does&gt;</code>
の呼び出しの後に実行する必要があることに注意してください。 なぜなら、 <code>set-does&gt;</code> は <code>compile,</code>
の実装それ自体を上書きするからです。
</p>
<p><code>fvalue-to</code> の例でわかるように、 <code>set-optimizer</code> を <code>constant</code> や
<code>fvalue</code> のような定義ワード内ではなく、 個々のワードに適用することもできます。  この場合、 オプティマイザに渡されるワードの xt
は通常は不要であり、 <code>compile-fvalue-to</code> のように <code>drop</code> されます。
</p>
<p>エンジン <code>gforth-itc</code> は <code>compile,</code> に <code>,</code> を使用するので、 そこでは
<code>set-optimizer</code> は効果ありません。
</p>

</div>
<hr>
<div class="header">
<p>
Next: <a href="Creating-from-a-prototype.html">Creating from a prototype</a>, Previous: <a href="User_002ddefined-TO-and-DEFER_0040.html">User-defined <code>to</code> and <code>defer@</code></a>, Up: <a href="User_002ddefined-Defining-Words.html">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
