<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>User-defined defining words using CREATE (Gforth マニュアル)</title>

<meta name="description" content="User-defined defining words using CREATE (Gforth マニュアル)">
<meta name="keywords" content="User-defined defining words using CREATE (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="User_002ddefined-Defining-Words.html" rel="up" title="User-defined Defining Words">
<link href="CREATE_002e_002eDOES_003e-applications.html" rel="next" title="CREATE..DOES&gt; applications">
<link href="User_002ddefined-defining-words-with-colon-definitions.html" rel="prev" title="User-defined defining words with colon definitions">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsubsection" id="User_002ddefined-defining-words-using-CREATE">
<div class="header">
<p>
Next: <a href="CREATE_002e_002eDOES_003e-applications.html" accesskey="n" rel="next">Applications of <code>CREATE..DOES&gt;</code></a>, Previous: <a href="User_002ddefined-defining-words-with-colon-definitions.html" accesskey="p" rel="prev">User-defined defining words with colon definitions</a>, Up: <a href="User_002ddefined-Defining-Words.html" accesskey="u" rel="up">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="User_002ddefined-defining-words-using-create"></span><h4 class="subsubsection">6.10.10.2 User-defined defining words using create</h4>
<span id="index-CREATE-_002e_002e_002e-DOES_003e"></span>

<p>定義ワードで定義されたワードを、 標準の定義ワードで定義されたワードとは異なる振る舞いにしたい場合は、 以下のように定義ワードを記述できます:
</p>
<div class="example">
<pre class="example">: def-word ( &quot;name&quot; -- )
    CREATE <i>code1</i>
DOES&gt; ( ... -- ... )
    <i>code2</i> ;

def-word name
</pre></div>

<span id="index-child-words"></span>
<p>This fragment defines a <em>defining word</em> <code>def-word</code> and then
executes it.  When <code>def-word</code> executes, it <code>CREATE</code>s a new word
<code>name</code>, and executes the code <i>code1</i>. The code <i>code2</i> is not
executed at this time. The word <code>name</code> is sometimes called a
<em>child</em> of <code>def-word</code>.
</p>
<p>When you execute <code>name</code>, the address of the body of <code>name</code> is put
on the data stack and <i>code2</i> is executed (the address of the body of
<code>name</code> is the address <code>HERE</code> returns immediately after the
<code>CREATE</code>, i.e., the address a <code>create</code>d word returns by default).
</p>
<p>You can use <code>def-word</code> to define a set of child words that behave
similarly; they all have a common run-time behaviour determined by
<i>code2</i>. Typically, the <i>code1</i> sequence builds a data area in the body
of the child word. The structure of the data is common to all children of
<code>def-word</code>, but the data values are specific &ndash; and private &ndash; to each
child word. When a child word is executed, the address of its private data
area is passed as a parameter on TOS to be used and manipulated<a id="DOCF16" href="#FOOT16"><sup>16</sup></a> by <i>code2</i>.
</p>
<p>The two fragments of code that make up the defining words act (are executed)
at two completely separate times:
</p>
<ul>
<li> At <i>define time</i>, the defining word executes <i>code1</i> to generate a child
word
</li><li> At <i>child execution time</i>, when a child word is invoked, <i>code2</i> is
executed, using parameters (data) that are private and specific to the child
word.
</li></ul>

<p>Another way of understanding the behaviour of <code>def-word</code> and
<code>name</code> is to say that, if you make the following definitions:
</p><div class="example">
<pre class="example">: def-word1 ( &quot;name&quot; -- )
    CREATE <i>code1</i> ;

: action1 ( ... -- ... )
    <i>code2</i> ;

def-word1 name1
</pre></div>

<p>Then using <code>name1 action1</code> is equivalent to using <code>name</code>.
</p>
<span id="index-CREATE-_002e_002e_002e-SET_002dDOES_003e"></span>
<p>Another way of writing <code>def-word</code> is (see <a href="Quotations.html">Quotations</a>):
</p>
<div class="example">
<pre class="example">: def-word ( &quot;name&quot; -- ; name execution: ... -- ... )
    create <i>code1</i>
    [: <i>code2</i> ;] set-does&gt; ;
</pre></div>

<p>Gforth actually compiles the code using <code>does&gt;</code> into code equivalent to
the latter code.  An advantage of the <code>set-does&gt;</code> approach is that you
can put other code behind it and you can use it inside control structures
without needing workarounds.  A disadvantage is that it is Gforth-specific.
</p>
<p>A classic example is that you can define <code>CONSTANT</code> in this way:
</p>
<div class="example">
<pre class="example">: CONSTANT ( w &quot;name&quot; -- )
    CREATE ,
DOES&gt; ( -- w )
    @ ;
</pre></div>

<p>or equivalently
</p>
<div class="example">
<pre class="example">: CONSTANT ( w &quot;name&quot; -- ; name execution: -- w )
    create ,
    ['] @ set-does&gt; ;
</pre></div>


<p>When you create a constant with <code>5 CONSTANT five</code>, a set of define-time
actions take place; first a new word <code>five</code> is created, then the value
5 is laid down in the body of <code>five</code> with <code>,</code>. When <code>five</code> is
executed, the address of the body is put on the stack, and <code>@</code>
retrieves the value 5. The word <code>five</code> has no code of its own; it
simply contains a data field and the xt of the quotation or of <code>@</code>.
</p>
<p>The final example in this section is intended to remind you that space
reserved in <code>CREATE</code>d words is <i>data</i> space and therefore can be both
read and written by a Standard program<a id="DOCF17" href="#FOOT17"><sup>17</sup></a>:
</p>
<div class="example">
<pre class="example">: foo ( &quot;name&quot; -- )
    CREATE -1 ,
DOES&gt; ( -- )
    @ . ;

foo first-word
foo second-word

123 ' first-word &gt;BODY !
</pre></div>

<p>If <code>first-word</code> had been a <code>CREATE</code>d word, we could simply have
executed it to get the address of its data field. However, since it was
defined to have <code>DOES&gt;</code> actions, its execution semantics are to perform
those <code>DOES&gt;</code> actions. To get the address of its data field it&rsquo;s
necessary to use <code>'</code> to get its xt, then <code>&gt;BODY</code> to translate the
xt into the address of the data field.  When you execute <code>first-word</code>,
it will display <code>123</code>. When you execute <code>second-word</code> it will
display <code>-1</code>.
</p>
<span id="index-stack-effect-of-DOES_003e_002dparts"></span>
<span id="index-DOES_003e_002dparts_002c-stack-effect"></span>
<p>In the examples above the stack comment after the <code>DOES&gt;</code> specifies the
stack effect of the defined words, not the stack effect of the following
code (the following code expects the address of the body on the top of
stack, which is not reflected in the stack comment). This is the convention
that I use and recommend (it clashes a bit with using locals declarations
for stack effect specification, though).
</p>

</div>
<div class="footnote">
<hr>
<h4 class="footnotes-heading">Footnotes</h4>

<h5><a id="FOOT16" href="#DOCF16">(16)</a></h5>
<p>It
is legitimate both to read and write to this data area.</p>
<h5><a id="FOOT17" href="#DOCF17">(17)</a></h5>
<p>Exercise: use this example
as a starting point for your own implementation of <code>Value</code> and
<code>TO</code> &ndash; if you get stuck, investigate the behaviour of <code>'</code> and
<code>[']</code>.</p>
</div>
<hr>
<div class="header">
<p>
Next: <a href="CREATE_002e_002eDOES_003e-applications.html">Applications of <code>CREATE..DOES&gt;</code></a>, Previous: <a href="User_002ddefined-defining-words-with-colon-definitions.html">User-defined defining words with colon definitions</a>, Up: <a href="User_002ddefined-Defining-Words.html">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
