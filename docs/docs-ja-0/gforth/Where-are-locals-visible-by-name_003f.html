<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Where are locals visible by name? (Gforth マニュアル)</title>

<meta name="description" content="Where are locals visible by name? (Gforth マニュアル)">
<meta name="keywords" content="Where are locals visible by name? (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Gforth-locals.html" rel="up" title="Gforth locals">
<link href="How-long-do-locals-live_003f.html" rel="next" title="How long do locals live?">
<link href="Locals-definition-words.html" rel="prev" title="Locals definition words">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsubsection" id="Where-are-locals-visible-by-name_003f">
<div class="header">
<p>
Next: <a href="How-long-do-locals-live_003f.html" accesskey="n" rel="next">How long do locals live?</a>, Previous: <a href="Locals-definition-words.html" accesskey="p" rel="prev">Locals definitions words</a>, Up: <a href="Gforth-locals.html" accesskey="u" rel="up">Gforth locals</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="Where-are-locals-visible-by-name_003f-1"></span><h4 class="subsubsection">6.22.1.2 Where are locals visible by name?</h4>
<span id="index-locals-visibility"></span>
<span id="index-visibility-of-locals"></span>
<span id="index-scope-of-locals"></span>

<p>ローカル変数をその名前によって可視できるのはどこまででしょうか？ &ndash; 基本的に、 その答えは、 ローカル変数がブロック構造言語で期待される場所で、
場合によってはもうちょっとだけ長くできます。 ローカル変数のスコープを制限したい場合は、 その定義を
<code>SCOPE</code>...<code>ENDSCOPE</code> で囲んで下さい。
</p>

<span id="index-scope-_0028--compilation-_002d_002d-scope-_003b-run_002dtime-_002d_002d--_0029-gforth_002d0_002e2"></span>
<span id="index-scope"></span>
<span id="index-scope-1"></span>
<div class="format">
<pre class="format"><code>scope</code> ( <i>compilation  &ndash; scope ; run-time  &ndash;  </i>) gforth-0.2 &ldquo;scope&rdquo;
</pre></div>

<span id="index-endscope-_0028--compilation-scope-_002d_002d-_003b-run_002dtime-_002d_002d--_0029-gforth_002d0_002e2"></span>
<span id="index-endscope"></span>
<span id="index-endscope-1"></span>
<div class="format">
<pre class="format"><code>endscope</code> ( <i>compilation scope &ndash; ; run-time  &ndash;  </i>) gforth-0.2 &ldquo;endscope&rdquo;
</pre></div>



<p>これらのワードは制御構造のワードのように動作するため、 <code>CS-PICK</code> および <code>CS-ROLL</code> とともに使用して、
任意の方法で範囲を制限できます。
</p>
<p>可視性の質問に対するより正確な答えが必要な場合のために、 ここで基本原則を示します: ローカル変数は、
ローカル変数の定義を通じてのみ到達できるすべての場所で可視です<a id="DOCF30" href="#FOOT30"><sup>30</sup></a>。
つまり、 ローカル変数という定義を経由しないと到達できる場所では不可視です。 たとえば、 <code>IF</code>...<code>ENDIF</code>
の中で定義されたローカル変数は <code>ENDIF</code> まで可視で、 <code>BEGIN</code>...<code>UNTIL</code>
内で定義されたローカル変数は <code>UNTIL</code> の後(たとえば、後続の <code>ENDSCOPE</code> まで)で可視です。
</p>
<p>このソリューションの背景にある理由は次のとおりです: 私達は、 意味がある限り、 ローカル変数を可視させたいと考えています。 ユーザーは、
明示的なスコープを使用することで、 いつでも可視性を短くすることができます。 ローカル変数の定義によってのみ到達できる場所では、
ローカル変数名の意味は明らかです。 他の場所ではそうではありません。
ローカル変数定義が含まれていない制御フロー・パスでローカル変数はどのように初期化されるのでしょうか？  2 つの独立した制御フロー
パスで同一ローカル変数名が 2 回定義されている場合、 それはどちらのローカル変数を意味するのでしょうか？
</p>
<p>上記で、 ほぼすべてのユーザーにとって十分詳細であるため、 このセクションの残りの部分はスキップしてかまいません。
本当にすべての血みどろの詳細とオプションを知る必要がある場合は、 以下を読み続けてください。
</p>
<p>このルールを実装するには、 コンパイラはどの場所が到達不能(unreachable)であるかを認識する必要があります。 <code>AHEAD</code> や
<code>AGAIN</code> や <code>EXIT</code> や <code>LEAVE</code> の後で、 これが自動的に認識されます。 他の場合(例: ほとんどの
<code>THROW</code> の後)、 <code>UNREACHABLE</code> というワードを使用して、
制御フローがその場所に到達しないことをコンパイラに伝えることができます。 <code>UNREACHABLE</code> が使用できる場所で使用されなかった場合、
唯一の結果は、 一部のローカル変数の可視性が上記のルールに記載されているよりも制限されることです。 <code>UNREACHABLE</code>
を使用すべきではない場所で使用すると(つまり、 コンパイラに嘘をついた場合)、 バグのあるコードが生成されます。
</p>

<span id="index-UNREACHABLE-_0028--_002d_002d--_0029-gforth_002d0_002e2"></span>
<span id="index-UNREACHABLE"></span>
<span id="index-UNREACHABLE-1"></span>
<div class="format">
<pre class="format"><code>UNREACHABLE</code> ( <i>&ndash;  </i>) gforth-0.2 &ldquo;UNREACHABLE&rdquo;
</pre></div>



<p>このルールのもう 1 つの問題は、 <code>BEGIN</code> で、 どのローカル変数が incoming back-edge
で可視されるかをコンパイラが認識できないことです。 以下で説明するすべての問題は、 コンパイラのこの無知が原因です(<code>BEGIN</code>
ループを例として使用してこの問題について説明します。 この説明は <code>?DO</code> および他のループにも当てはまります)。
おそらく最も陰険な例は以下のとおりです:
</p><div class="example">
<pre class="example">AHEAD
BEGIN
  x
[ 1 CS-ROLL ] THEN
  {: x :}
  ...
UNTIL
</pre></div>

<p>これは、 可視性ルールに従って合法である必要があります。 <code>x</code> の使用には、 定義を介してのみ到達できます。 ただし、
下記に明示した使用法でなければなりません。
</p>
<p>この例から、 可視性ルールを完全に実装するには大きな問題が伴うことが明らかです。 私たちの実装は、 一般的なケースを宣伝どおりに扱い、
例外は安全な方法で処理されます。 コンパイラは、 <code>BEGIN</code> の後に可視できるローカル変数について合理的な推測を行います。
悲観的すぎると、 ローカル変数が定義されていないという偽のエラーがユーザーに表示されます。 コンパイラが楽観的すぎる場合、 後でこれに気づき、
警告を発行します。 上記の場合、 コンパイラは <code>x</code> が使用時に未定義であることについて文句を言います。 このセクションのあいまいな例から、
コンパイラをトラブルに陥らせるには非常に特殊な制御構造が必要であることがわかりますが、 それでもコンパイラは多くの場合問題なく動作します。
</p>
<p><code>BEGIN</code> がそれより上から到達可能な場合、 最も楽観的な推測は、 <code>BEGIN</code> の前に可視であるすべてのローカル変数も
<code>BEGIN</code> の後にも可視であることです。 この推測は、 <code>BEGIN</code> 経由でのみ入るすべてのループ、 特に通常の
<code>BEGIN</code>...<code>WHILE</code>...<code>REPEAT</code> および <code>BEGIN</code>...<code>UNTIL</code>
ループに対して有効であり、 コンパイラに実装されています。 <code>BEGIN</code> への分岐が <code>AGAIN</code> または
<code>UNTIL</code> によって最終的に生成されると、 コンパイラは推測をチェックし、 それが楽観的すぎる場合はユーザーに警告します:
</p><div class="example">
<pre class="example">IF
  {: x :}
BEGIN
  \ x ? 
[ 1 cs-roll ] THEN
  ...
UNTIL
</pre></div>

<p>ここで、 <code>x</code> は <code>BEGIN</code> までのみ存続しますが、 コンパイラは <code>THEN</code>
まで存続すると楽観的に想定します。 <code>UNTIL</code> をコンパイルするときにこの違いに気づき、 警告を発行します。 ユーザーは警告を回避し、
明示的なスコープを使用して <code>x</code> が間違った領域で使用されていないことを確認できます:
</p><div class="example">
<pre class="example">IF
  SCOPE
  {: x :}
  ENDSCOPE
BEGIN
[ 1 cs-roll ] THEN
  ...
UNTIL
</pre></div>

<p>推測は楽観的であるため、 未定義のローカル変数に関する偽のエラー・メッセージは表示されません。
</p>
<p><code>BEGIN</code> がそれより上から到達可能でない場合(たとえば、 <code>AHEAD</code> または <code>EXIT</code> の後)、
<code>BEGIN</code> の後で定義されたローカル変数の可視については、 コンパイラは楽観的な推測を行うことさえできません。
</p>
<p>悲観的に、 制御構造の外側の最新の場所(つまり、 制御フロー・スタック上に何もない場所)で可視であったすべてのローカル変数が可視であると仮定します。
これは以下のことを意味します:
</p>
<div class="example">
<pre class="example">: foo
  IF {: z :} THEN
  {: x :}
  AHEAD
    BEGIN
      ( * )
    [ 1 CS-ROLL ] THEN
    {: y :}
    ...
  UNTIL ;
</pre></div>

<p>ここで、 <code>( * )</code> でマークされた場所では、 <code>x</code> は可視ですが、 <code>y</code> は不可視です(ただし、
到達可能性ルールによれば、 可視であるべきです)。 <code>z</code> はそこでは不可視で、 可視であるべきではありません。
</p>
<p>ただし、 <code>ASSUME-LIVE</code> を使用すると、 最上位の制御フロー・スタック項目が作成された時点と同じローカル変数が BEGIN
で可視になるのだと、 コンパイラに想定させることができます。
</p>

<span id="index-ASSUME_002dLIVE-_0028--orig-_002d_002d-orig--_0029-gforth_002d0_002e2"></span>
<span id="index-ASSUME_002dLIVE"></span>
<span id="index-ASSUME_002dLIVE-1"></span>
<div class="format">
<pre class="format"><code>ASSUME-LIVE</code> ( <i>orig &ndash; orig  </i>) gforth-0.2 &ldquo;ASSUME-LIVE&rdquo;
</pre></div>



<p>例えば、 以下のように使います
</p><div class="example">
<pre class="example">IF
  {: x :}
  AHEAD
    ASSUME-LIVE
    BEGIN
      x
    [ 1 CS-ROLL ] THEN
    ...
  UNTIL
THEN
</pre></div>

<p>ここで、 <code>x</code> のローカル変数定義は制御構造内にあるため、 <code>x</code> を使用した時点では <code>x</code> は可視ではありませんが、
<code>ASSUME-LIVE</code> を使用することで、 プログラマはコンパイラに <code>AHEAD</code> の時点で可視である、 そのローカル変数が、
<code>BEGIN</code> の時点でも可視であるべきであると伝えます。
</p>
<p><code>BEGIN</code> の前にローカル変数が定義されている他のケースは、 <code>ASSUME-LIVE</code> の前に適切な
<code>CS-ROLL</code> を挿入する(そして <code>ASSUME-LIVE</code>
の背後にある制御フロー・スタック操作を変更する)ことで処理できます。
</p>
<p>ローカル変数が <code>BEGIN</code> の後で定義されている場合(ただし、 <code>BEGIN</code> の直後で可視である必要があります)は、
ループを再配置することによってのみ処理できます。 たとえば、上記の「最も陰険な」例は以下のように整理できます:
</p><div class="example">
<pre class="example">BEGIN
  {: x :}
  ... 0=
WHILE
  x
REPEAT
</pre></div>

</div>
<div class="footnote">
<hr>
<h4 class="footnotes-heading">Footnotes</h4>

<h5><a id="FOOT30" href="#DOCF30">(30)</a></h5>
<p>コンパイラ構築用語では「すべての場所はローカル変数の定義によって支配される」と言う</p>
</div>
<hr>
<div class="header">
<p>
Next: <a href="How-long-do-locals-live_003f.html">How long do locals live?</a>, Previous: <a href="Locals-definition-words.html">Locals definitions words</a>, Up: <a href="Gforth-locals.html">Gforth locals</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
