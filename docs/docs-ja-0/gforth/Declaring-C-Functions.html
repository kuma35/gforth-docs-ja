<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Declaring C Functions (Gforth マニュアル)</title>

<meta name="description" content="Declaring C Functions (Gforth マニュアル)">
<meta name="keywords" content="Declaring C Functions (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="C-Interface.html" rel="up" title="C Interface">
<link href="Calling-C-function-pointers.html" rel="next" title="Calling C function pointers">
<link href="Calling-C-Functions.html" rel="prev" title="Calling C Functions">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsection" id="Declaring-C-Functions">
<div class="header">
<p>
Next: <a href="Calling-C-function-pointers.html" accesskey="n" rel="next">Calling C function pointers from Forth</a>, Previous: <a href="Calling-C-Functions.html" accesskey="p" rel="prev">Calling C functions</a>, Up: <a href="C-Interface.html" accesskey="u" rel="up">C Interface</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="Declaring-C-Functions-1"></span><h4 class="subsection">6.28.2 Declaring C Functions</h4>
<span id="index-C-functions_002c-declarations"></span>
<span id="index-declaring-C-functions"></span>

<p>あなたは、 先の例の <code>lseek</code> や <code>dlseek</code> を呼び出す前に、 宣言する必要があります。  宣言は以下の 2
つの部分で構成されます: 
</p>
<dl compact="compact">
<dt><span><b>C言語部分</b></span></dt>
<dd><p>関数の C 言語宣言です。 より一般的かつ移植性の高いものとしては、 C 言語の関数の宣言を含むファイルの C 言語スタイルの
<code>#include</code> です。
</p>
</dd>
<dt><span><b>Forth部分</b></span></dt>
<dd><p>パラメータの Forth 型と、 C言語の関数に対応する Forth ワード名を宣言します。
</p>
</dd>
</dl>

<p>前述の <code>lseek</code> と <code>dlseek</code> の宣言は以下のとおりです:
</p>
<div class="example">
<pre class="example">\c #define _FILE_OFFSET_BITS 64
\c #include &lt;sys/types.h&gt;
\c #include &lt;unistd.h&gt;
c-function lseek lseek n n n -- n
c-function dlseek lseek n d n -- d
</pre></div>

<p>宣言の C言語部分は <code>\c</code> という接頭辞が付けられ、 <code>\c</code> の行の残りの部分は通常の C 言語のコードです。 C
言語の宣言の行は好きなだけ使用でき、 それ以降のすべての関数宣言で参照できます。
</p>
<p>Forth 部分は、 <code>c-function</code> で各インターフェイス・ワードを宣言し、 その後にワードの Forth 名と、 呼び出される C
言語の関数名と、 ワードのスタック効果が続きます。  スタック効果には、 任意の数のパラメータのタイプ、 <code>--</code>、 そして戻り値の「 1
つ」のタイプが含まれます。  可能なタイプは以下のとおりです:
</p>
<dl compact="compact">
<dt><span><code>n</code></span></dt>
<dd><p>単一セル整数
</p>
</dd>
<dt><span><code>a</code></span></dt>
<dd><p>アドレス(単一セル)
</p>
</dd>
<dt><span><code>d</code></span></dt>
<dd><p>2倍長セル整数
</p>
</dd>
<dt><span><code>r</code></span></dt>
<dd><p>浮動小数点数値
</p>
</dd>
<dt><span><code>func</code></span></dt>
<dd><p>C言語の関数へのポインタ
</p>
</dd>
<dt><span><code>void</code></span></dt>
<dd><p>値なし(void 関数の戻り値の型として使用)
</p>
</dd>
</dl>

<span id="index-variadic-C-functions"></span>

<p>可変個の引数(variadic)の C 言語の関数を扱うには、 あなたが使用したいパターンごとに 1 つの Forth ワードを宣言します。 例:
</p>
<div class="example">
<pre class="example">\c #include &lt;stdio.h&gt;
c-function printf-nr printf a n r -- n
c-function printf-rn printf a r n -- n
</pre></div>

<p>注意: C 言語の関数が可変個(variadic)の引数として宣言されている場合(または関数プロトタイプを提供していない場合)、 C
言語インターフェイスには変換先の C 言語の型がないため、 自動変換は行われず、
場合によっては移植性の問題が発生する可能性があることに注意してください。  C 言語の型キャストを中括弧で囲んで Forth 型の後に追加できます。
これにより、 例えば、 Forth ではスタック上に存在できない構造体を C 言語の関数へ渡す事も可能になります。
</p>
<div class="example">
<pre class="example">c-function printfll printf a n{(long long)} -- n
c-function pass-struct pass_struct a{*(struct foo *)} -- n
</pre></div>

<p>C言語では左辺値(lvalues)の型キャスト(typecast)が許可されていないため、 この型キャストは戻り値には使用できません。
</p>
<span id="index-_005cc-_0028--_0022rest_002dof_002dline_0022-_002d_002d--_0029-gforth_002d0_002e7"></span>
<span id="index-_005cc"></span>
<span id="index-_005cc-1"></span>
<div class="format">
<pre class="format"><code>\c</code> ( <i>&quot;rest-of-line&quot; &ndash;  </i>) gforth-0.7 &ldquo;backslash-c&rdquo;
</pre></div>
<p>C言語インターフェイスのC言語宣言の1行
</p>

<span id="index-c_002dfunction-_0028--_0022forth_002dname_0022-_0022c_002dname_0022-_0022_007btype_007d_0022-_0022_002d_002d_002d_0022-_0022type_0022-_002d_002d--_0029-gforth_002d0_002e7"></span>
<span id="index-c_002dfunction"></span>
<span id="index-c_002dfunction-1"></span>
<div class="format">
<pre class="format"><code>c-function</code> ( <i>&quot;forth-name&quot; &quot;c-name&quot; &quot;{type}&quot; &quot;&ndash;&quot; &quot;type&quot; &ndash;  </i>) gforth-0.7 &ldquo;c-function&rdquo;
</pre></div>
<p>Forth ワード <i>forth-name</i> を定義します。  <i>Forth-name</i> には指定されたスタック効果(<i>{type}</i>
と <i>type</i>)があり、 C言語関数 <code>c-name</code> を呼び出します。
</p>

<span id="index-c_002dvalue-_0028--_0022forth_002dname_0022-_0022c_002dname_0022-_0022_002d_002d_002d_0022-_0022type_0022-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-c_002dvalue"></span>
<span id="index-c_002dvalue-1"></span>
<div class="format">
<pre class="format"><code>c-value</code> ( <i>&quot;forth-name&quot; &quot;c-name&quot; &quot;&ndash;&quot; &quot;type&quot; &ndash;  </i>) gforth-1.0 &ldquo;c-value&rdquo;
</pre></div>
<p>Forth ワード <i>forth-name</i> を定義します。  <i>Forth-name</i> には指定されたスタック効果(<i>type</i>)があり、
<code>c-name</code> の C言語からの値を与えます(訳注: スタック効果の通り、 読み取りのみ)。
</p>

<span id="index-c_002dvariable-_0028--_0022forth_002dname_0022-_0022c_002dname_0022-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-c_002dvariable"></span>
<span id="index-c_002dvariable-1"></span>
<div class="format">
<pre class="format"><code>c-variable</code> ( <i>&quot;forth-name&quot; &quot;c-name&quot; &ndash;  </i>) gforth-1.0 &ldquo;c-variable&rdquo;
</pre></div>
<p>Forth ワード <i>forth-name</i> を定義します。  <i>Forth-name</i> は <code>c-name</code> のアドレスを返します。
</p>


<p>この C言語インターフェイスが機能するために、 実行時に GCC を呼び出し、 動的リンク(dynamic linking)を使用します。
これらの機能が利用できない場合は、 <samp>lib.fs</samp> と <samp>oldlib.fs</samp> に、利便性と移植性に劣る他の C
言語インターフェイスが用意されています。 これらのインターフェイスはほとんど文書化されておらず、 また文書化された
C言語インターフェイスとほとんど互換性がありません。 あなたが例を見たければ、 <samp>lib.fs</samp> インターフェイスの例が
<samp>lib.fs</samp> にあります。
</p>

</div>
<hr>
<div class="header">
<p>
Next: <a href="Calling-C-function-pointers.html">Calling C function pointers from Forth</a>, Previous: <a href="Calling-C-Functions.html">Calling C functions</a>, Up: <a href="C-Interface.html">C Interface</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
