<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright © 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Image File Background (Gforth マニュアル)</title>

<meta name="description" content="Image File Background (Gforth マニュアル)">
<meta name="keywords" content="Image File Background (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Image-Files.html" rel="up" title="Image Files">
<link href="Non_002dRelocatable-Image-Files.html" rel="next" title="Non-Relocatable Image Files">
<link href="Image-Licensing-Issues.html" rel="prev" title="Image Licensing Issues">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span:hover a.copiable-link {visibility: visible}
ul.mark-bullet {list-style-type: disc}
ul.mark-minus {list-style-type: "\2212"}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="section-level-extent" id="Image-File-Background">
<div class="nav-panel">
<p>
Next: <a href="Non_002dRelocatable-Image-Files.html" accesskey="n" rel="next">Non-Relocatable Image Files</a>, Previous: <a href="Image-Licensing-Issues.html" accesskey="p" rel="prev">Image Licensing Issues</a>, Up: <a href="Image-Files.html" accesskey="u" rel="up">Image Files</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h3 class="section" id="Image-File-Background-1"><span>14.2 Image File Background<a class="copiable-link" href="#Image-File-Background-1"> &para;</a></span></h3>
<a class="index-entry-id" id="index-image-file-background"></a>

<p>Gforth は、 (エンジン内の) リミティブだけでなく、 Forth で書かれた定義でも構成されます。 Forth
コンパイラー自体もこれらの定義に含まれているため、 エンジンと Forth ソースだけでシステムを起動することはできません。したがって、 Forth
コードをほぼ実行可能な形式のイメージ・ファイルとして提供します。  Gforth が起動すると、
C言語のルーチンがイメージ・ファイルをメモリーにロードし、 オプションでアドレスを再配置し、
イメージ・ファイル内の情報に従ってメモリー(スタックなど)を設定し、 (最終的に) Forth コードの実行を開始します。
</p>
<p>デフォルトのイメージ・ファイルは <samp class="file">gforth.fi</samp> (<code class="code">GFORTHPATH</code> 上の何処か)です。  <code class="code">-i</code>
または <code class="code">--image-file</code> または <code class="code">--appl-image</code> オプションを使用すると、
別のイメージを使用できます(see <a class="pxref" href="Invoking-Gforth.html">Invoking Gforth</a>)。 例:
</p>
<div class="example">
<pre class="example-preformatted">gforth-fast -i myimage.fi
</pre></div>

<p>イメージ・ファイルにはさまざまなバリエーションがあり、 イメージ・ファイルの生成を容易にするという目標と、
イメージ・ファイルを移植できるようにするという目標の間のさまざまな妥協点を表しています。
</p>
<a class="index-entry-id" id="index-relocation-at-run_002dtime"></a>
<p>Win32Forth 3.4 と、  Mitch Bradley の <code class="code">cforth</code> は実行時に再配置を使用します。 これにより、
以下で説明する複雑な問題の多くが回避されます(イメージ・ファイルは、 特に手間をかけることなくデータを再配置できます)が、 しかし、
パフォーマンスが低下し(メモリー・アクセスごとに 1 回の追加)、 そして、 Forth
とライブラリ呼び出しまたは他のプログラムの間でアドレスを渡すことが困難になります。
</p>
<a class="index-entry-id" id="index-relocation-at-load_002dtime"></a>
<p>対照的に、 Gforth ローダーはイメージのロード時に再配置を実行します。 また、 ローダーは、
プリミティブ呼び出しを表すトークンを適切なコード・フィールド・アドレス(直接スレッドの場合はコード・アドレス)に置き換える必要があります。
</p>
<p>イメージ・ファイルには、 再配置の程度が異なる 3 種類があります。 つまり、 再配置不可能なイメージ・ファイルと、
データ再配置可能なイメージ・ファイルと、 完全に再配置可能なイメージ・ファイルです。
</p>
<a class="index-entry-id" id="index-image-file-loader"></a>
<a class="index-entry-id" id="index-relocating-loader"></a>
<a class="index-entry-id" id="index-loader-for-image-files"></a>
<p>これらのイメージ・ファイルのバリエーションには、 いくつかの共通の制限があります。 それらは、
イメージ・ファイル・ローダーの設計によって引き起こされます:
</p>
<ul class="itemize mark-bullet">
<li>セグメントは 1 つだけです。 これは、特に、 イメージ・ファイルが <code class="code">ALLOCATE</code>
されたメモリー・チャンク(およびそれらへのポインター)を表すことができないことを意味します。 スタックの内容も表現されません。

</li><li>サポートされている再配置の種類は次のとおりです: データ・アドレスを表すすべてのセルに同じオフセットを追加します。 そして、
特別なトークンをコード・アドレスまたはマシン・コードの一片に置き換えます。

<p>アドレスを含む複雑な計算が実行される場合、 結果はイメージ・ファイルで表現できません。
このような計算を使用するアプリケーションがいくつか思い浮かびます:
</p>
<ul class="itemize mark-minus">
<li>テーブル・ルックアップのためのアドレス(またはアドレスを含むデータ構造)のハッシュ化。 この目的に Gforth の <code class="code">table</code> または
<code class="code">wordlist</code> を使用する場合、 システムの起動時にハッシュ・テーブルが自動的に再計算されるため、問題はありません。
あなた独自のハッシュ・テーブルを使用する場合は、 同様のことをあなた自身で行う必要があります。

</li><li><code class="code">XOR</code> されたアドレスを使用する二重リンク・リストの小さい実装があります。
このようなリストをイメージ・ファイル内で単一リンクとして表現し、 起動時に二重リンク表現を復元することもできます<a class="footnote" id="DOCF36" href="#FOOT36"><sup>36</sup></a>。 

</li><li><code class="code">docol:</code> のようなランタイム・ルーチンのコード・アドレスは、
イメージ・ファイルでは表現できません(直接スレッド実装ではトークンがマシン・コードに置き換えられるため)。 回避策として、 実行時に
<code class="code">&gt;code-address</code>
を使用して適切なワードの実行トークンからこれらのアドレスを計算します(<samp class="file">kernel/getdoers.fs</samp> の <code class="code">docol:</code>
とそのファミリーの定義を参照してください)。

</li><li>多くのアーキテクチャでは、 アドレスは何らかのシフトされた形式または切り刻んだ(mangle)形式でマシン・コードで表現されます。
この形式の絶対アドレスを含む <code class="code">CODE</code> ワードを再配置可能イメージ・ファイルに含めることはできません。
回避策は、アドレスを何らかの相対形式(たとえば、 レジ​​スタに存在する CFA を基準とした相対形式)で表現するか、
アドレスが切り刻んでない(mangle)形式で格納されている場所からロードすることです。
</li></ul>
</li></ul>

</div>
<div class="footnotes-segment">
<hr>
<h4 class="footnotes-heading">Footnotes</h4>

<h5 class="footnote-body-heading"><a id="FOOT36" href="#DOCF36">(36)</a></h5>
<p>ただし、
著者の意見としては、 (実装がどうであれ)二重リンク・リストを使用する前によく考えるべきです。</p>
</div>



</body>
</html>
