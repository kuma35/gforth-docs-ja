<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Dynamic Superinstructions (Gforth マニュアル)</title>

<meta name="description" content="Dynamic Superinstructions (Gforth マニュアル)">
<meta name="keywords" content="Dynamic Superinstructions (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Threading.html" rel="up" title="Threading">
<link href="DOES_003e.html" rel="next" title="DOES&gt;">
<link href="Direct-or-Indirect-Threaded_003f.html" rel="prev" title="Direct or Indirect Threaded?">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsection" id="Dynamic-Superinstructions">
<div class="header">
<p>
Next: <a href="DOES_003e.html" accesskey="n" rel="next">DOES&gt;</a>, Previous: <a href="Direct-or-Indirect-Threaded_003f.html" accesskey="p" rel="prev">Direct or Indirect Threaded?</a>, Up: <a href="Threading.html" accesskey="u" rel="up">Threading</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="Dynamic-Superinstructions-1"></span><h4 class="subsection">15.2.3 Dynamic Superinstructions</h4>
<span id="index-Dynamic-superinstructions-with-replication"></span>
<span id="index-Superinstructions"></span>
<span id="index-Replication"></span>

<p><code>gforth</code> エンジンと <code>gforth-fast</code> エンジンは、 別の最適化、 つまり、
レプリケーションを伴う動的スーパー命令(Dynamic superinstructions with replication)を使用します。
例として、 以下のコロン定義について考えてみましょう:
</p>
<div class="example">
<pre class="example">: squared ( n1 -- n2 )
  dup * ;
</pre></div>

<p>Gforth はこれを以下のスレッド化コード・シーケンスにコンパイルします
</p>
<div class="example">
<pre class="example">dup
*
;s
</pre></div>

<p><code>simple-see</code> (see <a href="Examining-compiled-code.html">Examining compiled code</a>)を使用して、
コロン定義のスレッド化コードを確認します。
</p>
<p>通常の直接スレッド化コードでは、 上記のプリミティブごとに 1 つのセルを占めるコード・アドレスがあります。
各コード・アドレスはマシン・コード・ルーチンを指し、 インタプリタはプリミティブを実行するためにこのマシン・コードにジャンプします。  上記 3
つのプリミティブのルーチンは以下のとおりです(386 の <code>gforth-fast</code> の場合):
</p>
<div class="example">
<pre class="example">Code dup  
( $804B950 )  add     esi , # -4  \ $83 $C6 $FC 
( $804B953 )  add     ebx , # 4  \ $83 $C3 $4 
( $804B956 )  mov     dword ptr 4 [esi] , ecx  \ $89 $4E $4 
( $804B959 )  jmp     dword ptr FC [ebx]  \ $FF $63 $FC 
end-code
Code *  
( $804ACC4 )  mov     eax , dword ptr 4 [esi]  \ $8B $46 $4 
( $804ACC7 )  add     esi , # 4  \ $83 $C6 $4 
( $804ACCA )  add     ebx , # 4  \ $83 $C3 $4 
( $804ACCD )  imul    ecx , eax  \ $F $AF $C8 
( $804ACD0 )  jmp     dword ptr FC [ebx]  \ $FF $63 $FC 
end-code
Code ;s  
( $804A693 )  mov     eax , dword ptr [edi]  \ $8B $7 
( $804A695 )  add     edi , # 4  \ $83 $C7 $4 
( $804A698 )  lea     ebx , dword ptr 4 [eax]  \ $8D $58 $4 
( $804A69B )  jmp     dword ptr FC [ebx]  \ $FF $63 $FC 
end-code
</pre></div>

<p>動的なスーパー命令とレプリケーションを使用すると、 コンパイラーはスレッド化されたコードを配置しないだけでなく、 コード断片のコピーも行い、
通常は各コード断片最後で行うジャンプを行いません。
</p>
<div class="example">
<pre class="example">( $4057D27D )  add     esi , # -4  \ $83 $C6 $FC 
( $4057D280 )  add     ebx , # 4  \ $83 $C3 $4 
( $4057D283 )  mov     dword ptr 4 [esi] , ecx  \ $89 $4E $4 
( $4057D286 )  mov     eax , dword ptr 4 [esi]  \ $8B $46 $4 
( $4057D289 )  add     esi , # 4  \ $83 $C6 $4 
( $4057D28C )  add     ebx , # 4  \ $83 $C3 $4 
( $4057D28F )  imul    ecx , eax  \ $F $AF $C8 
( $4057D292 )  mov     eax , dword ptr [edi]  \ $8B $7 
( $4057D294 )  add     edi , # 4  \ $83 $C7 $4 
( $4057D297 )  lea     ebx , dword ptr 4 [eax]  \ $8D $58 $4 
( $4057D29A )  jmp     dword ptr FC [ebx]  \ $FF $63 $FC 
</pre></div>

<p>スレッド化コードの制御フローに変更が発生した場合(<code>;s</code> など)にのみジャンプが追加されます。 この最適化により、
これらのジャンプの多くが排除され、 残りの部分がより予測可能になります。  高速化はプロセッサとアプリケーションによって異なります。 Athlon
および Pentium III では、 この最適化により通常 2 倍の速度向上が得られます。
</p>
<p>直接スレッド化コード内のコード・アドレスは、 コピーされたマシン・コード内の適切なポイントを指すように設定されます。 この例では以下のようになります:
</p>
<div class="example">
<pre class="example">primitive  code address
   dup       $4057D27D
   *         $4057D286
   ;s        $4057D292
</pre></div>

<p>したがって、 このコード部分の任意の場所にスレッド化コードからのジャンプ先が存在する可能性があります。  これにより、
逆コンパイルもかなり簡素化されます。
</p>
<p><code>See-code</code> (see <a href="Examining-compiled-code.html">Examining compiled code</a>)は、 動的スーパー命令(dynamic
superinstructions)のネイティブ・コードと混在するスレッド化コードを示します。  最近では、
動的に生成されたネイティブ・コードに追加の最適化が適用されているため、 特定の AMD64 インストール上の <code>gforth-fast</code> での
<code>see-code squared</code> の出力は以下のようになります:
</p>
<div class="example">
<pre class="example">$7FB689C678C8 dup    1-&gt;2 
7FB68990C1B2:   mov     r15,r8
$7FB689C678D0 *    2-&gt;1 
7FB68990C1B5:   imul    r8,r15
$7FB689C678D8 ;s    1-&gt;1 
7FB68990C1B9:   mov     rbx,[r14]
7FB68990C1BC:   add     r14,$08
7FB68990C1C0:   mov     rax,[rbx]
7FB68990C1C3:   jmp     eax
</pre></div>

<span id="index-_002d_002dno_002ddynamic-command_002dline-option"></span>
<span id="index-_002d_002dno_002dsuper-command_002dline-option"></span>
<p><samp>--no-dynamic</samp> を使用してこの最適化を無効にできます。  <samp>--no-super</samp> を使用すると、
ジャンプを排除せずにコピーを使用できます(つまり、 動的レプリケーション、 しかしスーパー命令は使用しません)。
これは分岐予測のみに利点をもたらします。 パフォーマンスへの影響は CPU によって異なります。 Athlon および Pentium III では、
レプリケーションを伴う動的スーパー命令(dynamic superinstructions with
replication)よりも高速化が若干損なわれます。
</p>
<span id="index-patching-threaded-code"></span>
<p>これらのオプションの用途の 1 つは、 スレッド化されたコードにパッチを適用する場合です。  スーパー命令を使用すると、
ディスパッチ・ジャンプの多くが削除されるため、 パッチを当てても効果がなくなることがよくあります。  これらのオプションは、
すべてのディスパッチ・ジャンプを保持します。
</p>
<span id="index-_002d_002ddynamic-command_002dline-option"></span>
<p>一部のマシンでは動的スーパー命令(dynamic superinstructions)は安全ではないため、 デフォルトで無効になっています。
しかしながら、 あなたが冒険してみたい場合は、 <samp>--dynamic</samp> を使用して有効にすることができます。
</p>
</div>
<hr>
<div class="header">
<p>
Next: <a href="DOES_003e.html">DOES&gt;</a>, Previous: <a href="Direct-or-Indirect-Threaded_003f.html">Direct or Indirect Threaded?</a>, Up: <a href="Threading.html">Threading</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
