<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>User-defined defining words using CREATE (Gforth マニュアル)</title>

<meta name="description" content="User-defined defining words using CREATE (Gforth マニュアル)">
<meta name="keywords" content="User-defined defining words using CREATE (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="User_002ddefined-Defining-Words.html" rel="up" title="User-defined Defining Words">
<link href="CREATE_002e_002eDOES_003e-applications.html" rel="next" title="CREATE..DOES&gt; applications">
<link href="User_002ddefined-defining-words-with-colon-definitions.html" rel="prev" title="User-defined defining words with colon definitions">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsubsection" id="User_002ddefined-defining-words-using-CREATE">
<div class="header">
<p>
Next: <a href="CREATE_002e_002eDOES_003e-applications.html" accesskey="n" rel="next">Applications of <code>CREATE..DOES&gt;</code></a>, Previous: <a href="User_002ddefined-defining-words-with-colon-definitions.html" accesskey="p" rel="prev">User-defined defining words with colon definitions</a>, Up: <a href="User_002ddefined-Defining-Words.html" accesskey="u" rel="up">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="User_002ddefined-defining-words-using-create"></span><h4 class="subsubsection">6.10.10.2 User-defined defining words using create</h4>
<span id="index-CREATE-_002e_002e_002e-DOES_003e"></span>

<p>定義ワードで定義されたワードを、 標準の定義ワードで定義されたワードとは異なる振る舞いにしたい場合は、 以下のように定義ワードを記述できます:
</p>
<div class="example">
<pre class="example">: def-word ( &quot;name&quot; -- )
    CREATE <i>code1</i>
DOES&gt; ( ... -- ... )
    <i>code2</i> ;

def-word name
</pre></div>

<span id="index-child-words"></span>
<p>このコード断片は 定義ワード(<em>defining word</em>) <code>def-word</code> を定義し、 そして、 それを実行します。
<code>def-word</code> が実行されると、 新しいワード <code>name</code> が <code>CREATE</code> され、コード <i>code1</i>
が実行されます。 コード <i>code2</i> は現時点では実行されません。 <code>name</code> というワードは、 <code>def-word</code>
の子供(<em>child</em>)と呼ばれることもあります。
</p>
<p><code>name</code> を実行すると、 <code>name</code> の本体のアドレスがデータ・スタックに置かれ、 <i>code2</i>
が実行されます(<code>name</code> の本体のアドレスは、 <code>CREATE</code> の直後に <code>HERE</code> が返すアドレス、 つまり、
<code>create</code> されたワードがデフォルトで返すアドレスです)。
</p>
<p><code>def-word</code> を使用して、 同様に動作する一連の子ワード達を定義できます。 つまり、 これらはすべて <i>code2</i>
によって決定される共通の実行時の振る舞いを持っています。 通常、 <i>code1</i> シーケンスは、 子ワードの本体にデータ領域を構築します。
データの構造は <code>def-word</code> のすべての子に共通ですが、 データ値は各子ワードに固有で、 そして、 プライベートです。
子ワードが実行されると、 そのプライベート・データ領域のアドレスが TOS 上のパラメータとして渡され、 <i>code2</i>
によって使用および操作されます<a id="DOCF16" href="#FOOT16"><sup>16</sup></a>。
</p>
<p>定義ワードを構成する 2 つのコード断片は、 完全に別々の 2 つの時点で動作(実行)されます:
</p>
<ul>
<li> <i>定義時</i> 、定義ワードが <i>code1</i> を実行して子ワードを生成します
</li><li> <i>子の実行時</i>、 子ワードが呼び出されると、 子ワード固有のプライベートなパラメータ達(データ)を使って、 <i>code2</i> が実行されます。
</li></ul>

<p><code>def-word</code> と <code>name</code> の振る舞いを理解するもう 1 つの方法は、 以下のように定義することです:
</p><div class="example">
<pre class="example">: def-word1 ( &quot;name&quot; -- )
    CREATE <i>code1</i> ;

: action1 ( ... -- ... )
    <i>code2</i> ;

def-word1 name1
</pre></div>

<p>この場合、 <code>name1 action1</code> を使用することは、 <code>name</code> を使用することと同じです。
</p>
<span id="index-CREATE-_002e_002e_002e-SET_002dDOES_003e"></span>
<p><code>def-word</code> を記述するもう 1 つの方法が引用(see <a href="Quotations.html">Quotations</a>)です:
</p>
<div class="example">
<pre class="example">: def-word ( &quot;name&quot; -- ; name execution: ... -- ... )
    create <i>code1</i>
    [: <i>code2</i> ;] set-does&gt; ;
</pre></div>

<p>Gforth  は実際は <code>does&gt;</code> を使用してコードを後者のコードと同等のコードにコンパイルします。  <code>set-does&gt;</code>
アプローチの利点は、 その背後に他のコードを配置でき、 回避策を必要とせずに制御構造内でそれを使用できることです。  欠点は、 Gforth
固有であることです。
</p>
<p>典型的な例は、 以下のようにして <code>CONSTANT</code> を定義できることです:
</p>
<div class="example">
<pre class="example">: CONSTANT ( w &quot;name&quot; -- )
    CREATE ,
DOES&gt; ( -- w )
    @ ;
</pre></div>

<p>または同等の
</p>
<div class="example">
<pre class="example">: CONSTANT ( w &quot;name&quot; -- ; name execution: -- w )
    create ,
    ['] @ set-does&gt; ;
</pre></div>


<p><code>5 CONSTANT five</code> を使用して定数を作成すると、 一連の定義時アクションが実行されます。 最初に新しいワード
<code>five</code> が作成され、 次に <code>,</code> を使用して <code>five</code> の本体に値 5 が配置されます。
<code>five</code> が実行されると、 その本体のアドレスがスタックに置かれ、 <code>@</code> は値 5 を取得します。 ワード
<code>five</code> にはそれ自体のコードはありません。 ワード <code>five</code> には、 データ・フィールドと、 引用(quotation)
の xt または <code>@</code> の xt が含まれるだけです。
</p>
<p>このセクションの最後の例は、 <code>CREATE</code> されたワードで予約されている空間はデータ空間であるため、
標準プログラムによる読み取りと書き込みの両方が可能であることを思い出していただくことを目的としています<a id="DOCF17" href="#FOOT17"><sup>17</sup></a>:
</p>
<div class="example">
<pre class="example">: foo ( &quot;name&quot; -- )
    CREATE -1 ,
DOES&gt; ( -- )
    @ . ;

foo first-word
foo second-word

123 ' first-word &gt;BODY !
</pre></div>

<p><code>first-word</code> が <code>CREATE</code> されたワードであった場合、
単純にそれを実行してデータ・フィールドのアドレスを取得できます。 ただし、 <code>DOES&gt;</code> アクションを持つように定義されているため、
その実行機能(execution semantics)は、 それらの <code>DOES&gt;</code> アクションを実行することになります。
データ・フィールドのアドレスを取得するには、 <code>'</code> を使用して xt を取得し、 次に <code>&gt;BODY</code> を使用して xt
をデータ・フィールドのアドレスに変換する必要があります。  <code>first-word</code> を実行すると、 <code>123</code> が表示されます。
<code>second-word</code> を実行すると、<code>-1</code> が表示されます。
</p>
<span id="index-stack-effect-of-DOES_003e_002dparts"></span>
<span id="index-DOES_003e_002dparts_002c-stack-effect"></span>
<p>上記の例では、 <code>DOES&gt;</code> の後のスタック・コメントは、  <code>DOES&gt;</code> に続くコードのスタック効果ではなく、
定義されたワードのスタック効果を指定しています(<code>DOES&gt;</code>  に続くコードは、 本体のアドレスがスタックの先頭にある事を期待しています。
これはスタック・コメントには反映されません)。 これは著者の私が使用し、 推奨している規則です(ただし、
スタック効果の指定にローカル変数宣言を使うのと少々衝突する)。
</p>

</div>
<div class="footnote">
<hr>
<h4 class="footnotes-heading">Footnotes</h4>

<h5><a id="FOOT16" href="#DOCF16">(16)</a></h5>
<p>このデータ領域への読み取りと書き込みは両方とも正当です。</p>
<h5><a id="FOOT17" href="#DOCF17">(17)</a></h5>
<p>研究課題: この例は
<code>Value</code> と <code>TO</code> をあなた独自に実装するための出発点として使って見ましょう。 もし、 あなたが行き詰まった場合は、
<code>'</code> と <code>[']</code> の振る舞いを調べてください。</p>
</div>
<hr>
<div class="header">
<p>
Next: <a href="CREATE_002e_002eDOES_003e-applications.html">Applications of <code>CREATE..DOES&gt;</code></a>, Previous: <a href="User_002ddefined-defining-words-with-colon-definitions.html">User-defined defining words with colon definitions</a>, Up: <a href="User_002ddefined-Defining-Words.html">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
