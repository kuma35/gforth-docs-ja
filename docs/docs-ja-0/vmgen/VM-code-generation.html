<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 仮想マシン・インタープリタ・ジェネレーターである Vmgen (バージョン
0.7.9_20240418、April 18, 2024) 用です

Author: Anton Ertl Copyright © 2002,2003,2005,2007,2008,2019 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.2 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>VM code generation (Vmgen (Gforth 0.7.9_20240418))</title>

<meta name="description" content="VM code generation (Vmgen (Gforth 0.7.9_20240418))">
<meta name="keywords" content="VM code generation (Vmgen (Gforth 0.7.9_20240418))">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Using-the-generated-code.html" rel="up" title="Using the generated code">
<link href="Peephole-optimization.html" rel="next" title="Peephole optimization">
<link href="VM-instruction-table.html" rel="prev" title="VM instruction table">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span:hover a.copiable-link {visibility: visible}
-->
</style>


</head>

<body lang="en">
<div class="section-level-extent" id="VM-code-generation">
<div class="nav-panel">
<p>
Next: <a href="Peephole-optimization.html" accesskey="n" rel="next">Peephole optimization</a>, Previous: <a href="VM-instruction-table.html" accesskey="p" rel="prev">VM instruction table</a>, Up: <a href="Using-the-generated-code.html" accesskey="u" rel="up">Using the generated code</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h3 class="section" id="VM-code-generation-1"><span>8.3 VM code generation<a class="copiable-link" href="#VM-code-generation-1"> &para;</a></span></h3>
<a class="index-entry-id" id="index-VM-code-generation"></a>
<a class="index-entry-id" id="index-code-generation_002c-VM"></a>
<a class="index-entry-id" id="index-_002dgen_002ei-output-file"></a>

<p>Vmgen generates VM code generation functions in <samp class="file"><var class="var">name</var>-gen.i</samp> that
the front end can call to generate VM code.  This is essential for an
interpretive system.
</p>
<a class="index-entry-id" id="index-gen_005finst"></a>
<p>For a VM instruction &lsquo;<samp class="samp">x ( #a b #c -- d )</samp>&rsquo;, Vmgen generates a function
with the prototype
</p>
<div class="example">
<pre class="example-preformatted">void gen_x(Inst **ctp, a_type a, c_type c)
</pre></div>

<p>The <code class="code">ctp</code> argument points to a pointer to the next instruction.
<code class="code">*ctp</code> is increased by the generation functions; i.e., you should
allocate memory for the code to be generated beforehand, and start with *ctp
set at the start of this memory area.  Before running out of memory,
allocate a new area, and generate a VM-level jump to the new area (this
overflow handling is not implemented in our examples).
</p>
<a class="index-entry-id" id="index-immediate-arguments_002c-VM-code-generation"></a>
<p>The other arguments correspond to the immediate arguments of the VM
instruction (with their appropriate types as defined in the
<code class="code">type_prefix</code> declaration.
</p>
<p>The following types, variables, and functions are used in
<samp class="file"><var class="var">name</var>-gen.i</samp>:
</p>
<dl class="table">
<dt><a id="index-Inst"></a><span><code class="code">Inst</code><a class="copiable-link" href="#index-Inst"> &para;</a></span></dt>
<dd><p>The type of the VM instruction; if you use threaded code, this is <code class="code">void
*</code>; for switch dispatch this is an integer type.
</p>
</dd>
<dt><a id="index-vm_005fprim_002c-use"></a><span><code class="code">vm_prim</code><a class="copiable-link" href="#index-vm_005fprim_002c-use"> &para;</a></span></dt>
<dd><p>The VM instruction table (type: <code class="code">Inst *</code>, see <a class="pxref" href="VM-instruction-table.html">VM instruction table</a>).
</p>
</dd>
<dt><a id="index-gen_005finst-1"></a><span><code class="code">gen_inst(Inst **ctp, Inst i)</code><a class="copiable-link" href="#index-gen_005finst-1"> &para;</a></span></dt>
<dd><p>This function compiles the instruction <code class="code">i</code>.  Take a look at it in
<samp class="file">vmgen-ex/peephole.c</samp>.  It is trivial when you don&rsquo;t want to use
superinstructions (just the last two lines of the example function), and
slightly more complicated in the example due to its ability to use
superinstructions (see <a class="pxref" href="Peephole-optimization.html">Peephole optimization</a>).
</p>
</dd>
<dt><a id="index-genarg_005ftype_005fprefix"></a><span><code class="code">genarg_<var class="var">type_prefix</var>(Inst **ctp, <var class="var">type</var> <var class="var">type_prefix</var>)</code><a class="copiable-link" href="#index-genarg_005ftype_005fprefix"> &para;</a></span></dt>
<dd><p>This compiles an immediate argument of <var class="var">type</var> (as defined in a
<code class="code">type-prefix</code> definition).  These functions are trivial to define (see
<samp class="file">vmgen-ex/support.c</samp>).  You need one of these functions for every type
that you use as immediate argument.
</p>
</dd>
</dl>

<a class="index-entry-id" id="index-BB_005fBOUNDARY"></a>
<p>In addition to using these functions to generate code, you should call
<code class="code">BB_BOUNDARY</code> at every basic block entry point if you ever want to use
superinstructions (or if you want to use the profiling supported by Vmgen;
but this support is also useful mainly for selecting superinstructions).  If
you use <code class="code">BB_BOUNDARY</code>, you should also define it (take a look at its
definition in <samp class="file">vmgen-ex/mini.y</samp>).
</p>
<p>You do not need to call <code class="code">BB_BOUNDARY</code> after branches, because you will
not define superinstructions that contain branches in the middle (and if you
did, and it would work, there would be no reason to end the superinstruction
at the branch), and because the branches announce themselves to the
profiler.
</p>

</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="Peephole-optimization.html">Peephole optimization</a>, Previous: <a href="VM-instruction-table.html">VM instruction table</a>, Up: <a href="Using-the-generated-code.html">Using the generated code</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
