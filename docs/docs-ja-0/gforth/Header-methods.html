<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Header methods (Gforth マニュアル)</title>

<meta name="description" content="Header methods (Gforth マニュアル)">
<meta name="keywords" content="Header methods (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Carnal-words.html" rel="up" title="Carnal words">
<link href="Threading-Words.html" rel="next" title="Threading Words">
<link href="Header-fields.html" rel="prev" title="Header fields">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsection" id="Header-methods">
<div class="header">
<p>
Next: <a href="Threading-Words.html" accesskey="n" rel="next">Threading Words</a>, Previous: <a href="Header-fields.html" accesskey="p" rel="prev">Header fields</a>, Up: <a href="Carnal-words.html" accesskey="u" rel="up">Carnal words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="Header-methods-1"></span><h4 class="subsection">6.30.2 Header methods</h4>
<span id="index-header-methods"></span>

<p>新しい Gforth ワード・ヘッダーはオブジェクト指向であり、 以下のメソッド(メソッド・セレクター)をサポートします:
</p>
<div class="example">
<pre class="example">.hm label method          overrider        field
          execute         set-execute      &gt;cfa
opt:      opt-compile,    set-optimizer    &gt;hmcompile,
to:       (to)            set-to           &gt;hmto
extra:                                     &gt;hmextra
&gt;int:     name&gt;interpret  set-&gt;int         &gt;hm&gt;int
&gt;comp:    name&gt;compile    set-&gt;comp        &gt;hm&gt;comp
&gt;string:  name&gt;string     set-name&gt;string  &gt;hm&gt;string
&gt;link:    name&gt;link       set-name&gt;link    &gt;hm&gt;link
</pre></div>

<p>これらのワードの多くは定着(stable)した Gforth ワードではありませんが、 Gforth には後述する定着した高レベルのワードがあります。
</p>
<p>以下を使用すると、 ワードのヘッダー・メソッドを確認できます
</p>
<span id="index-_002ehm-_0028--nt-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-_002ehm"></span>
<span id="index-_002ehm-1"></span>
<div class="format">
<pre class="format"><code>.hm</code> ( <i>nt &ndash;  </i>) gforth-1.0 &ldquo;dot-h-m&rdquo;
</pre></div>
<p><i>nt</i> のヘッダー・メソッドを出力します
</p>


<p>オーバーライダー(overrider)(セッター)ワードは、 最新の定義のメソッド実装を変更します。  クォーテーションまたはクロージャーは、
完了時に以前の最新の定義を復元するため、 最新のものとはみなされず、 以下のようなことができます:
</p>
<div class="example">
<pre class="example">: my2dup over over ;
[: drop ]] over over [[ ;] set-optimizer
</pre></div>

<p><code>execute</code> メソッドは、 パフォーマンス上の理由から、 実際にはヘッダー・メソッド・テーブルではなくヘッダーの <code>&gt;cfa</code>
フィールドに格納されます。 また、 他のメソッドは xt を呼び出すことによって実装されますが、 ネイティブ・コード・アドレスを通じて実装されます。
このメソッドを設定する大まかな方法​​は以下のとおりです
</p>
<span id="index-set_002dexecute-_0028--ca-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-set_002dexecute"></span>
<span id="index-set_002dexecute-1"></span>
<div class="format">
<pre class="format"><code>set-execute</code> ( <i>ca &ndash;  </i>) gforth-1.0 &ldquo;set-execute&rdquo;
</pre></div>
<p><i>ca</i> のネイティブ・コードにジャンプするように現在のワードを変更します。  また、 <code>compile,</code>
実装を最も一般的な(そして最も遅い)実装に変更します。  より効率的な <code>compile,</code> 実装が必要な場合は、 後で
<code>set-optimizer</code> を呼び出します。
</p>


<p><code>set-execute</code> で使用するコード・アドレスを取得するには、 <code>docol:</code> または
<code>&gt;code-address</code> などのワードを使用できます。 See <a href="Threading-Words.html">Threading Words</a>
</p>
<p><code>set-execute</code> の代わりに、 xt を受け取る <code>set-does&gt;</code> (see <a href="User_002ddefined-Defining-Words.html">User-defined Defining Words</a>)もあります。
</p>
<p>さらに、 低レベルの <code>code-address!</code> と <code>definer!</code> があります。 (see <a href="Threading-Words.html">Threading Words</a>)
</p>
<p><code>opt-compile,</code> メソッドは、 ほとんどの Gforth エンジンで動く <code>compile,</code>
です(<code>gforth-itc</code> は代わりに <code>,</code> を使用します)。  <code>set-optimizer</code> を使用して、
現在のワードに対する <code>compile,</code> のより効率的な実装を定義できます((see <a href="User_002ddefined-compile_002dcomma.html">User-defined <code>compile,</code></a>))。 注意: 最終結果は <code>postpone literal postpone execute</code>
と同等でなければならないことに注意してください。
</p>
<p><code>set-optimizer</code> の使用例として、 以下の <code>constant</code> の定義を考えてみましょう:
</p>
<div class="example">
<pre class="example">: constant ( n &quot;name&quot; -- ; name: -- n )
  create ,
  ['] @ set-does&gt;
;

5 constant five
: foo five ; see foo
</pre></div>

<p>Forth システムは、 定数の値を変更してはならないことを認識せず、 単に <code>create</code> されたワード (<code>&gt;body</code>
で変更可能)として見て、 <code>foo</code> は最初に <code>five</code> のボティのアドレスをスタックにプッシュし、
その次にそこから値を取得します。 <code>set-optimizer</code> を使用すると、 <code>constant</code>
の定義を以下のように最適化できます:
</p>
<div class="example">
<pre class="example">: constant ( n &quot;name&quot; -- ; name: -- n )
  create ,
  ['] @ set-does&gt;
  [: &gt;body @ postpone literal ;] set-optimizer
;
</pre></div>

<p>いまや、 <code>foo</code> には、 <code>five</code> の呼び出しではなく、 即値(literal)の 5 が含まれるようになりました。
</p>
<p>注意: <code>set-execute</code> と <code>set-does&gt;</code> は、<code>execute</code> と <code>compile,</code>
が一致していることを確認するために、 <code>set-optimizer</code> 自体を実行することに注意してください。
あなた独自のオプティマイザーを追加するには、 後で追加する必要があります。
</p>
<p><code>defer!</code> (別名 <code>(to)</code> メソッド(see <a href="User_002ddefined-TO-and-DEFER_0040.html">User-defined <code>to</code> and <code>defer@</code></a>)は、
<code>defer</code> で定義されたワードおよび類似のワードに対して <code>defer!</code> を実装します。 ですが、 これは <code>to</code>
の核心(core)でもあります。 <code>defer!</code>/<code>(to)</code> メソッドの一般的なスタック効果は <code>( val xt
-- )</code> です。 ここで <i>xt</i> は格納されているワードを示し、 <i>val</i> はそこに格納されている(適切な型の)値です。
</p>
<p>たとえば、 以下のように <code>fvalue</code> を実装できます:
</p>
<div class="example">
<pre class="example">: fvalue-to ( r xt -- ) &gt;body f! ;

: fvalue ( r -- )
  create f,
  ['] f@ set-does&gt;
  ['] fvalue-to set-to ;

5e fvalue foo
: bar foo 1e f+ to foo ;
see bar
</pre></div>

<p><code>set-optimizer</code> を使用して、 生成されたコードを改善できます:
</p>
<div class="example">
<pre class="example">: compile-fvalue-to ( xt-value-to -- )
  drop ]] &gt;body f! [[ ;
  
: fvalue-to ( r xt -- ) &gt;body f! ;
' compile-fvalue-to set-optimizer

: fvalue ( r -- )
  create f,
  ['] f@ set-does&gt;
  [: &gt;body ]] literal f@ [[ ;] set-optimizer
  ['] fvalue-to set-to ;

5e fvalue foo
: bar foo 1e f+ to foo ;
see bar
</pre></div>

<p>実際には、 Gforth には、 <code>+TO</code> など、 実装するための追加の工夫がいくつかあります。
</p>
<p><code>Set-defer@</code> (see <a href="User_002ddefined-TO-and-DEFER_0040.html">User-defined <code>to</code> and <code>defer@</code></a>) を使用すると、
<code>defer</code> のようなワードに対して <code>defer@</code> (see <a href="Deferred-Words.html">Deferred Words</a>)
メソッドのバリエーションを実装できます。
</p>
<p><code>&gt;hmextra</code> フィールドは、 追加のデータをヘッダー・メソッド・テーブルに保存する必要がある場合に使用されます。  特に、 それは
<code>set-does&gt;</code> に渡す xt を保存し(そして <code>does&gt;</code> は <code>set-does&gt;</code> を呼び出し)、
そして、 <code>;abi-code</code> の後のコードのアドレスを保存します。
</p>
<p>これらのメソッドはすべて、 nt ではなく xt を使用しますが、 オーバーライド・ワード(override words)は最新の定義で機能します。
これは、 たとえば、 同義語(synonym)に対して <code>set-optimizer</code> を使用した場合、
その効果はおそらくあなたが意図したものとは異なることを意味します。 ワードの xt を <code>compile,</code> する場合、
新たに設定された同義語(synonym)ではなく、 元のワードの <code>opt-compile,</code> 実装が使用されます。
</p>
<p>以下のメソッド達は nt を消費します。
</p>
<p><code>name&gt;interpret</code> メソッドは、 同義語(synonym)や類似のワードを除くほとんどのワードに対して noop
として実装されます。
</p>
<span id="index-set_002d_003eint-_0028--xt-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-set_002d_003eint"></span>
<span id="index-set_002d_003eint-1"></span>
<div class="format">
<pre class="format"><code>set-&gt;int</code> ( <i>xt &ndash;  </i>) gforth-1.0 &ldquo;set-to-int&rdquo;
</pre></div>
<p>現在のワードの <code>name&gt;interpret (nt -- xt2 )</code> メソッドの実装を <i>xt</i> に設定します。
</p>


<p><code>name&gt;compile</code> メソッドは、 nt のコンパイル機能(compilation semantics)を生成します。
<code>set-&gt;comp</code> で変更することでコンパイル機能を変更できますが、 <code>name&gt;compile</code> のスタック効果のため、
目的のコンパイル機能の xt をプッシュするだけというほど単純ではありません。  一般に、 コンパイル機能の変更は避ける必要があり、 変更する場合は、
<code>immediate</code> または <code>interpret/compile:</code>
などの高レベル・ワードを使用してください(See <a href="Combined-words.html">Combined Words</a>)。
</p>
<span id="index-set_002d_003ecomp-_0028--xt-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-set_002d_003ecomp"></span>
<span id="index-set_002d_003ecomp-1"></span>
<div class="format">
<pre class="format"><code>set-&gt;comp</code> ( <i>xt &ndash;  </i>) gforth-1.0 &ldquo;set-to-comp&rdquo;
</pre></div>
<p>現在のワードの <code>name&gt;compile ( nt -- w xt2 )</code> メソッドの実装を <i>xt</i> に設定します。
</p>

<span id="index-immediate_003f-_0028--nt-_002d_002d-flag--_0029-gforth_002d1_002e0"></span>
<span id="index-immediate_003f"></span>
<span id="index-immediate_003f-1"></span>
<div class="format">
<pre class="format"><code>immediate?</code> ( <i>nt &ndash; flag  </i>) gforth-1.0 &ldquo;immediate?&rdquo;
</pre></div>
<p>ワード <i>nt</i> がデフォルト以外のコンパイル機能(compilation semantics)を持っている場合は true
(これは即時性(immediacy)の定義と完全には一致しませんが、
多くの人はワード語を「即時」(immediate)と呼ぶときはこれを意味しています)。
</p>


<p><code>Name&gt;string</code> および <code>Name&gt;link</code> は、 noname ヘッダーから  name と <code>&gt;f+c</code>
と <code>link</code> フィールドを削除できるようにするためのメソッドです。 これらのワードを使用すると意味のある結果が得られます。  通常、
<code>noname</code> を使用する場合を除き、 これらのメソッドの実装を変更することはありませんが、
あなたがそれでも必要とするなら以下をご覧ください
</p>
<span id="index-set_002dname_003estring-_0028--xt-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-set_002dname_003estring"></span>
<span id="index-set_002dname_003estring-1"></span>
<div class="format">
<pre class="format"><code>set-name&gt;string</code> ( <i>xt &ndash;  </i>) gforth-1.0 &ldquo;set-name-to-string&rdquo;
</pre></div>
<p>現在のワードの <code>name&gt;string ( nt -- addr u )</code> メソッドの実装を <i>xt</i> に設定します。
</p>

<span id="index-set_002dname_003elink-_0028--xt-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-set_002dname_003elink"></span>
<span id="index-set_002dname_003elink-1"></span>
<div class="format">
<pre class="format"><code>set-name&gt;link</code> ( <i>xt &ndash;  </i>) gforth-1.0 &ldquo;set-name-to-link&rdquo;
</pre></div>
<p>現在のワードの <code>name&gt;link (nt1 -- nt2|0 )</code> メソッドの実装を <i>xt</i> に設定します。
</p>


</div>
<hr>
<div class="header">
<p>
Next: <a href="Threading-Words.html">Threading Words</a>, Previous: <a href="Header-fields.html">Header fields</a>, Up: <a href="Carnal-words.html">Carnal words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
