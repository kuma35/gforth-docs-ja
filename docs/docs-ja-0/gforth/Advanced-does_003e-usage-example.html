<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright © 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Advanced does&gt; usage example (Gforth マニュアル)</title>

<meta name="description" content="Advanced does&gt; usage example (Gforth マニュアル)">
<meta name="keywords" content="Advanced does&gt; usage example (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="User_002ddefined-Defining-Words.html" rel="up" title="User-defined Defining Words">
<link href="User_002ddefined-TO-and-DEFER_0040.html" rel="next" title="User-defined TO and DEFER@">
<link href="CREATE_002e_002eDOES_003e-details.html" rel="prev" title="CREATE..DOES&gt; details">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span:hover a.copiable-link {visibility: visible}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsubsection-level-extent" id="Advanced-does_003e-usage-example">
<div class="nav-panel">
<p>
Next: <a href="User_002ddefined-TO-and-DEFER_0040.html" accesskey="n" rel="next">User-defined <code class="code">to</code> and <code class="code">defer@</code></a>, Previous: <a href="CREATE_002e_002eDOES_003e-details.html" accesskey="p" rel="prev">The gory details of <code class="code">CREATE..DOES&gt;</code></a>, Up: <a href="User_002ddefined-Defining-Words.html" accesskey="u" rel="up">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h4 class="subsubsection" id="Advanced-does_003e-usage-example-1"><span>6.10.10.5 Advanced does&gt; usage example<a class="copiable-link" href="#Advanced-does_003e-usage-example-1"> &para;</a></span></h4>

<p>MIPS 逆アセンブラー(<samp class="file">arch/mips/disasm.fs</samp>)には、
非常に反復的なスキームに従って逆アセンブルするための多くのワードが含まれています(訳注: very repetetive scheme;
repetitiveのスペルミスっぽい):
</p>
<div class="example">
<pre class="example-preformatted">:noname <var class="var">disasm-operands</var> s&quot; <var class="var">inst-name</var>&quot; type ;
<var class="var">entry-num</var> cells <var class="var">table</var> + !
</pre></div>

<p>もちろん、 これは共通点をくくり出して以下のような定義を可能にするというアイデアを刺激します:
</p>
<div class="example">
<pre class="example-preformatted"><var class="var">disasm-operands</var> <var class="var">entry-num</var> <var class="var">table</var> define-inst <var class="var">inst-name</var>
</pre></div>

<p>通常、 パラメータ <var class="var">disasm-operands</var> と <var class="var">table</var> は相関しています。 さらに、
著者が逆アセンブラーを作成する前に、 以下のような命令を定義するコードがすでに存在していました:
</p>
<div class="example">
<pre class="example-preformatted"><var class="var">entry-num</var> <var class="var">inst-format</var> <var class="var">inst-name</var>
</pre></div>

<p>このコードは assembler 由来で、 <samp class="file">arch/mips/insts.fs</samp> にあります。
</p>
<p>したがって、 実行時に上記のスキームを実行する <var class="var">inst-format</var> ワードを定義する必要がありました。 著者は、
まず最初に、ランタイム・コード生成を使用することを選択しました:
</p>
<div class="example">
<pre class="example-preformatted">: <var class="var">inst-format</var> ( entry-num &quot;name&quot; -- ; compiled code: addr w -- )
  :noname Postpone <var class="var">disasm-operands</var>
  name Postpone sliteral Postpone type Postpone ;
  swap cells <var class="var">table</var> + ! ;
</pre></div>

<p>注意: これにより、 上記のスキームの他に 2 つのパラメータが提供されることに注意してください。
</p>
<p>別の方法として、 <code class="code">create</code>/<code class="code">does&gt;</code> を使用してこれを記述することもできます:
</p>
<div class="example">
<pre class="example-preformatted">: <var class="var">inst-format</var> ( entry-num &quot;name&quot; -- )
  here name string, ( entry-num c-addr ) \ parse and save &quot;name&quot;
  noname create , ( entry-num )
  latestxt swap cells <var class="var">table</var> + !
does&gt; ( addr w -- )
  \ disassemble instruction w at addr
  @ &gt;r 
  <var class="var">disasm-operands</var>
  r&gt; count type ;
</pre></div>

<p>どういうわけか、 最初の解決策の方が簡単です。 その主な理由は、 <code class="code">string,</code> やその友達を使用するよりも、
<code class="code">sliteral</code> を使用した方が、 文字列を定義時から使用時へシフトするのが簡単だからです。
</p>
<p>私はこのスキームに従ってたくさんのワードを書き、 すぐにそれらの共通点を取り出すことを考えました。  これは 2 レベルの定義ワード、
つまり通常の定義ワードを定義するワードを使用していることに注意してください。
</p>
<p>今回は、 <code class="code">postpone</code> とそのファミリーが関与する解決策はより困難に思えたので(研究課題として試してみましょう)、
<code class="code">create</code>/<code class="code">does&gt;</code> というワードを使用することにしました。 私はすでにそれを行っていたので、 下位レベルにも
<code class="code">create</code>/<code class="code">does&gt;</code> を使用しました(研究課題として <code class="code">postpone</code> などを使用してみましょう)。
その結果、 以下の定義が得られました:
</p>
<div class="example">
<pre class="example-preformatted">: define-format ( disasm-xt table-xt -- )
    \ 逆アセンブルに disasm-xt を使用する命令フォーマットを定義し、
    \ 定義された命令を
    \ 表(table) table-xt に入れます
    create 2,
does&gt; ( u &quot;inst&quot; -- )
    \ 命令 inst を逆アセンブルする匿名ワードを定義し、
    \ それを u 番目のエントリとして table-xt に入れます
    2@ swap here name string, ( u table-xt disasm-xt c-addr ) \ remember string
    noname create 2,      \ define anonymous word
    execute latestxt swap ! \ enter xt of defined word into table-xt
does&gt; ( addr w -- )
    \ disassemble instruction w at addr
    2@ &gt;r ( addr w disasm-xt R: c-addr )
    execute ( R: c-addr ) \ disassemble operands
    r&gt; count type ; \ print name 
</pre></div>

<p>注意: ここでのテーブルは(上記とは対照的に) <code class="code">cells +</code> を単独で実行することに注意してください (そのため、xt
を渡す必要があります)。  このワードは以下のように使用されます:
</p>
<div class="example">
<pre class="example-preformatted">' <var class="var">disasm-operands</var> ' <var class="var">table</var> define-format <var class="var">inst-format</var>
</pre></div>

<p>上に示したように、 定義された命令フォーマットは以下のように使用されます:
</p>
<div class="example">
<pre class="example-preformatted"><var class="var">entry-num</var> <var class="var">inst-format</var> <var class="var">inst-name</var>
</pre></div>

<p>カリー化に関しては、 この種の 2 レベルの定義ワードは 3 段階でパラメータを提供します。 最初に <var class="var">disasm-operands</var> と
<var class="var">table</var>、 次に <var class="var">entry-num</var> と <var class="var">inst-name </var>、最後に <code class="code">addr w</code> つまり、
逆アセンブル対象の命令です。  
</p>
<p>もちろん、 これは <samp class="file">insts.fs</samp> で使用されるすべての命令フォーマット名に完全に適合するわけではないため、
パラメータを正しい形式に条件付けるいくつかのラッパーを定義する必要がありました。
</p>
<p>あなたが、 このセクションを理解するのが難しい場合でも、 心配する必要はありません。  まず、 これは複雑であり、
理解するのに時間がかかります(おそらく多少いじくりまわすことも必要です)。 2 番目に、 これは私が Forth の 17 年間で書いた最初の 2
レベルの <code class="code">create</code>/<code class="code">does&gt;</code> ワードです。 また、 最初に <samp class="file">insts.fs</samp> がなかった場合は、 1
レベルの定義ワードのみを使用することを選択した可能性があります(定義ワードを使用するときにパラメータをいくつか繰り返します)。 したがって、
これを理解する必要はありませんが、 あなたの Forth についての理解が深まるかもしれません。
</p>


</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="User_002ddefined-TO-and-DEFER_0040.html">User-defined <code class="code">to</code> and <code class="code">defer@</code></a>, Previous: <a href="CREATE_002e_002eDOES_003e-details.html">The gory details of <code class="code">CREATE..DOES&gt;</code></a>, Up: <a href="User_002ddefined-Defining-Words.html">User-defined Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
