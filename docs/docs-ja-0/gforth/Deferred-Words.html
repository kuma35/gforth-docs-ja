<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Deferred Words (Gforth マニュアル)</title>

<meta name="description" content="Deferred Words (Gforth マニュアル)">
<meta name="keywords" content="Deferred Words (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Defining-Words.html" rel="up" title="Defining Words">
<link href="Forward.html" rel="next" title="Forward">
<link href="User_002ddefined-Defining-Words.html" rel="prev" title="User-defined Defining Words">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsection" id="Deferred-Words">
<div class="header">
<p>
Next: <a href="Forward.html" accesskey="n" rel="next">Forward</a>, Previous: <a href="User_002ddefined-Defining-Words.html" accesskey="p" rel="prev">User-defined Defining Words</a>, Up: <a href="Defining-Words.html" accesskey="u" rel="up">Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="Deferred-Words-1"></span><h4 class="subsection">6.10.11 Deferred Words</h4>
<span id="index-deferred-words"></span>

<p>定義ワード <code>defer</code> を使用すると、 その振る舞いを定義せずに名前でワードを定義できます。
その振る舞いの定義は延期(defer)されます。 これが役立つ 2 つの状況を以下に示します:
</p>
<ul>
<li> ワードの振る舞いを後で変更できるようにし、 振る舞いが変更されたときにそのワードへの全てのプリコンパイルされた参照も変更できるようにしたい場合。
</li><li> 相互再帰(mutual recursion)の場合。 See <a href="Calls-and-returns.html">Calls and returns</a>
</li></ul>

<p>以下の例では、 <code>foo</code> は常に <code>greet</code> の「<code>Good breakfast</code>」を出力するバージョンを呼び出し、
<code>bar</code> は常に<code>greet</code> の「<code>Hello</code>」を出力するバージョンを呼び出します。
ソースコードを並べ替えて再コンパイルすることなく、 <code>foo</code> で新しいバージョンを使用できるようにする方法はありません。
</p>
<div class="example">
<pre class="example">: greet .&quot; Good morning&quot; ;
: foo ... greet ... ;
: greet .&quot; Hello&quot; ;
: bar ... greet ... ;
</pre></div>

<p>この問題は、 <code>greet</code> を 延期(<code>Defer</code>)ワードとして定義することで解決できます。 延期ワードの振る舞いは、
<code>IS</code> を使用して以前に定義されたワードの xt と関連付けることによって、 いつでも定義および再定義できます。
上記の例は以下のようになります:
</p>
<div class="example">
<pre class="example">Defer greet ( -- )
: foo ... greet ... ;
: bar ... greet ... ;
: greet1 ( -- ) .&quot; Good morning&quot; ;
: greet2 ( -- ) .&quot; Hello&quot; ;
' greet2 IS greet  \ make greet behave like greet2
</pre></div>

<p>プログラミング・スタイル・メモ:
 すべての延期ワードに対してスタック・コメントを記述し、 かつ、 そのスタック効果に一致する XT
のみを延期ワードに入れる必要があります。 そうしないと、 延期ワードを使用するのは非常に困難です。
</p>
<p>延期ワードを使用すると、 <a href="User_002ddefined-Defining-Words.html">User-defined Defining Words</a> の統計収集の例(statistics-gathering
example)を改善できます。 アプリケーションのソース・コードを編集してすべての <code>:</code> を <code>my:</code> に変更するのではなく、
以下のようにします:
</p>
<div class="example">
<pre class="example">: real: : ;     \ retain access to the original
defer :         \ redefine as a deferred word
' my: IS :      \ use special version of :
\
\ load application here
\
' real: IS :    \ go back to the original
</pre></div>


<p>注意すべき点の 1 つは、 <code>IS</code> には特別なコンパイル機能(compilation semantics)があり、 (<code>TO</code>
のように)コンパイル時に名前をパースするということです:
</p>
<div class="example">
<pre class="example">: set-greet ( xt -- )
  IS greet ;

' greet1 set-greet
</pre></div>

<p><code>IS</code> が適合しない状況では、 代わりに <code>defer!</code> を使用してください。
</p>
<p>延期(defer)ワードは、 xt から実行機能(execution semantics)のみを継承できます(xt
が表現できるのはそれだけであるためです &ndash; これについての詳しい説明は see <a href="Tokens-for-Words.html">Tokens for Words</a> 参照)。
デフォルトでは、この実行機能(execution semantics)から派生したデフォルトのインタプリタ機能(interpretation
semantics)とコンパイル機能(compilation semantics)を持ちます。  ただし、
延期ワードのインタプリタ機能とコンパイル機能は、 通常の方法で変更できます。
</p>
<div class="example">
<pre class="example">: bar .... ; immediate
Defer fred immediate
Defer jim

' bar IS jim  \ jim has default semantics
' bar IS fred \ fred is immediate
</pre></div>

<span id="index-Defer-_0028--_0022name_0022-_002d_002d--_0029-core_002dext"></span>
<span id="index-Defer"></span>
<span id="index-Defer-1"></span>
<div class="format">
<pre class="format"><code>Defer</code> ( <i>&quot;name&quot; &ndash;  </i>) core-ext &ldquo;Defer&rdquo;
</pre></div>
<p>延期(defer)ワード <i>name</i> を定義します。 その実行機能(execution semantics)は <code>defer!</code> または
<code>is</code> で設定できます(最初に <i>name</i> を実行する前に設定する必要があります)。
</p>

<span id="index-defer_0021-_0028--xt-xt_002ddeferred-_002d_002d--_0029-core_002dext"></span>
<span id="index-defer_0021"></span>
<span id="index-defer_0021-1"></span>
<div class="format">
<pre class="format"><code>defer!</code> ( <i>xt xt-deferred &ndash;  </i>) core-ext &ldquo;defer-store&rdquo;
</pre></div>
<p>xt (<var>xt-deferred</var>) で表される延期(defer)ワードに実行のための <var>xt</var> を設定します。
</p>

<span id="index-IS-_0028--xt-_0022name_0022-_002d_002d--_0029-core_002dext"></span>
<span id="index-IS"></span>
<span id="index-IS-1"></span>
<div class="format">
<pre class="format"><code>IS</code> ( <i>xt &quot;name&quot; &ndash;  </i>) core-ext &ldquo;IS&rdquo;
</pre></div>
<p>延期(<code>defer</code>)ワード <var>name</var> に実行のための <var>xt</var> を設定します。
</p>

<span id="index-defer_0040-_0028--xt_002ddeferred-_002d_002d-xt--_0029-core_002dext"></span>
<span id="index-defer_0040"></span>
<span id="index-defer_0040-1"></span>
<div class="format">
<pre class="format"><code>defer@</code> ( <i>xt-deferred &ndash; xt  </i>) core-ext &ldquo;new-defer-fetch&rdquo;
</pre></div>
<p><i>xt</i> は、 延期ワード <i>xt-deferred</i> に現在関連付けられているワードを表します。
</p>

<span id="index-action_002dof-_0028--interpretation-_0022name_0022-_002d_002d-xt_003b-compilation-_0022name_0022-_002d_002d-_003b-run_002dtime-_002d_002d-xt--_0029-core_002dext"></span>
<span id="index-action_002dof"></span>
<span id="index-action_002dof-1"></span>
<div class="format">
<pre class="format"><code>action-of</code> ( <i>interpretation &quot;name&quot; &ndash; xt; compilation &quot;name&quot; &ndash; ; run-time &ndash; xt  </i>) core-ext &ldquo;action-of&rdquo;
</pre></div>
<p><i>Xt</i> は、 現在 <i>name</i> に割り当てられている XT です。
</p>



<p>Forth-94 では、 これら Forth-2012 のワードの定義は、<samp>compat/defer.fs</samp> で提供されます。  さらに、
Gforth は以下を提供します:
</p>
<span id="index-defers-_0028--compilation-_0022name_0022-_002d_002d-_003b-run_002dtime-_002e_002e_002e-_002d_002d-_002e_002e_002e--_0029-gforth_002d0_002e2"></span>
<span id="index-defers"></span>
<span id="index-defers-1"></span>
<div class="format">
<pre class="format"><code>defers</code> ( <i>compilation &quot;name&quot; &ndash; ; run-time ... &ndash; ...  </i>) gforth-0.2 &ldquo;defers&rdquo;
</pre></div>
<p>延期(defer)ワード <i>name</i> の現在の内容を現在の定義にコンパイルします。  つまり、 これにより、 <i>name</i>
が延期されなかったかのように静的バインディングが生成されます。
</p>

<span id="index-wrap_002dxt-_0028--xt1-xt2-xt_003a-xt3-_002d_002d-_002e_002e_002e--_0029-gforth_002d1_002e0"></span>
<span id="index-wrap_002dxt"></span>
<span id="index-wrap_002dxt-1"></span>
<div class="format">
<pre class="format"><code>wrap-xt</code> ( <i>xt1 xt2 xt: xt3 &ndash; ...  </i>) gforth-1.0 &ldquo;wrap-xt&rdquo;
</pre></div>
<p>延期(defer)ワード xt2 の現在の xt を退避して xt1 に設定した上で、 xt3 を実行し、 xt3 実行後、 退避した xt を
延期ワード xt2 に戻します(訳注: xt3 の内部のどこかで xt2 を使っているとして、 その実行機能を一時的に xt1 に設定してから xt3
を実行し、実行後に xt2 の実行機能を元に戻しておく。 元に戻すのは try ... restore ... endtry で囲まれた部分なので
xt3 実行中にエラーがあっても確実に復旧される。 詳しくはソースコード見て下さい)
</p>

<span id="index-preserve-_0028--_0022name_0022-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-preserve"></span>
<span id="index-preserve-1"></span>
<div class="format">
<pre class="format"><code>preserve</code> ( <i>&quot;name&quot; &ndash;  </i>) gforth-1.0 &ldquo;preserve&rdquo;
</pre></div>
<p>指定の延期(defer)ワード <i>name</i> で、 現在設定されている実行機能 <i>xt</i> を、 その場で <code>is</code> や
<code>defer!</code> したかのようなコードに変換します(訳注: 上記例より、 &rsquo; greet2 is greet  :
preserve-greet2 preserve greet ; → greet1 is greet  ok  → greet Good morning
ok → preserve-greet2  ok → greet Hello ok ; see preserve-greet2 → :
preserve-greet2  &lsquo;greet2 &lsquo;greet ! ; ok)
</p>



</div>
<hr>
<div class="header">
<p>
Next: <a href="Forward.html">Forward</a>, Previous: <a href="User_002ddefined-Defining-Words.html">User-defined Defining Words</a>, Up: <a href="Defining-Words.html">Defining Words</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
