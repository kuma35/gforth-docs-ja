<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.8, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- このマニュアルは、 標準 Forth 言語の高速で移植可能な実装である Gforth (バージョン 0.7.9_20240418,
April 18, 2024)用です。 これはリファレンス・マニュアルとして機能しますが、 Forth の概要と Forth
チュートリアルも含まれています。

Authors: Bernd Paysan, Anton Ertl, Gerald Wodni Copyright (C) 1995,
1996, 1997, 1998, 2000, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
2011, 2012, 2013, 2014,2015,2016,2017,2018,2019,2020,2021,2022,2023 Free
Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document under
the terms of the GNU Free Documentation License, Version 1.1 or any later
version published by the Free Software Foundation; with no Invariant
Sections, with the Front-Cover texts being "A GNU Manual," and with the
Back-Cover Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have freedom to copy and modify this
GNU Manual, like GNU software.  Copies published by the Free Software
Foundation raise funds for GNU development." -->
<title>Closures (Gforth マニュアル)</title>

<meta name="description" content="Closures (Gforth マニュアル)">
<meta name="keywords" content="Closures (Gforth マニュアル)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Word-Index.html" rel="index" title="Word Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Gforth-locals.html" rel="up" title="Gforth locals">
<link href="Locals-implementation.html" rel="prev" title="Locals implementation">
<style type="text/css">
<!--
a.copiable-anchor {visibility: hidden; text-decoration: none; line-height: 0em}
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
span:hover a.copiable-anchor {visibility: visible}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="gforth.css">


</head>

<body lang="en">
<div class="subsubsection" id="Closures">
<div class="header">
<p>
Previous: <a href="Locals-implementation.html" accesskey="p" rel="prev">Locals implementation</a>, Up: <a href="Gforth-locals.html" accesskey="u" rel="up">Gforth locals</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="Closures-1"></span><h4 class="subsubsection">6.22.1.6 Closures</h4>
<span id="index-closures"></span>

<p>Gforth は基礎的なクロージャ(closure)も提供します。  クロージャは、
引用(quotation)(see <a href="Quotations.html">Quotations</a>)とローカル変数の組み合わせです。  Gforth のクロージャには、
クロージャの実行時に値が入力されるローカル変数があり、 トランポリン xt (trampoline xt)が生成されます。  そのトランポリン xt を
execute すると、 ローカル・スタック上のクロージャのローカル変数にアクセスして、 クロージャのコードが実行されます。
クロージャのローカル変数の変更は永続的ではありません。 つまり、 クロージャが <code>EXIT</code> されると、 変更された値は失われます。
</p>
<span id="index-_005b_007b_003a-_0028--_002d_002d-hmaddr-u-latest-latestnt-wid-0--_0029-gforth_002dexperimental"></span>
<span id="index-_005b_007b_003a"></span>
<span id="index-_005b_007b_003a-1"></span>
<div class="format">
<pre class="format"><code>[{:</code> ( <i>&ndash; hmaddr u latest latestnt wid 0  </i>) gforth-experimental &ldquo;start-closure&rdquo;
</pre></div>
<p>クロージャを開始します。  クロージャはまず、 クロージャのために使用するローカル変数フレームを宣言し、
次にそれらのローカル変数で実行されるコードを宣言します。  クロージャは引用(quotations)のように <code>;]</code> で終わります。
ローカル宣言は、 クロージャ・ローカルが作成される場所に応じて終了します。  実行時、 クロージャは トランポリン xt として作成され、
スタックからローカル変数・フレームの値を埋めます。  xt の実行時に、 ローカル変数・フレームがローカル・スタックにコピーされ、
クロージャのコード内で使用されます。  戻った後、 これらの値はローカル・スタックから削除され、 クロージャ自体は更新されません。
</p>

<span id="index-_003a_007dl-_0028--hmaddr-u-latest-latestnt-wid-0-a_002daddr1-u1-_002e_002e_002e-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-_003a_007dl"></span>
<div class="format">
<pre class="format"><code>:}l</code> ( <i>hmaddr u latest latestnt wid 0 a-addr1 u1 ... &ndash;  </i>) gforth-1.0 &ldquo;close-brace-locals&rdquo;
</pre></div>
<p>クロージャ・ローカルの宣言を終了します。 クロージャはローカル・スタックに割り当てられます。
</p>

<span id="index-_003a_007dd-_0028--hmaddr-u-latest-latestnt-wid-0-a_002daddr1-u1-_002e_002e_002e-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-_003a_007dd"></span>
<div class="format">
<pre class="format"><code>:}d</code> ( <i>hmaddr u latest latestnt wid 0 a-addr1 u1 ... &ndash;  </i>) gforth-1.0 &ldquo;colon-close-brace-d&rdquo;
</pre></div>
<p>クロージャ・ローカル宣言を終了します。  クロージャはディクショナリに割り当てられます。
</p>

<span id="index-_003a_007dh-_0028--hmaddr-u-latest-latestnt-wid-0-a_002daddr1-u1-_002e_002e_002e-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-_003a_007dh"></span>
<div class="format">
<pre class="format"><code>:}h</code> ( <i>hmaddr u latest latestnt wid 0 a-addr1 u1 ... &ndash;  </i>) gforth-1.0 &ldquo;colon-close-brace-h&rdquo;
</pre></div>
<p>クロージャ・ローカル宣言を終了します。  クロージャーはヒープに割り当てられます。
</p>

<span id="index-_003a_007dh1-_0028--hmaddr-u-latest-latestnt-wid-0-a_002daddr1-u1-_002e_002e_002e-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-_003a_007dh1"></span>
<div class="format">
<pre class="format"><code>:}h1</code> ( <i>hmaddr u latest latestnt wid 0 a-addr1 u1 ... &ndash;  </i>) gforth-1.0 &ldquo;colon-close-brace-h&rdquo;
</pre></div>
<p>クロージャ・ローカル宣言を終了します。  クロージャーはヒープに割り当てられます。
</p>

<span id="index-_003a_007dxt-_0028--hmaddr-u-latest-latestnt-wid-0-a_002daddr1-u1-_002e_002e_002e-_002d_002d--_0029-gforth_002d1_002e0"></span>
<span id="index-_003a_007dxt"></span>
<div class="format">
<pre class="format"><code>:}xt</code> ( <i>hmaddr u latest latestnt wid 0 a-addr1 u1 ... &ndash;  </i>) gforth-1.0 &ldquo;colon-close-brace-x-t&rdquo;
</pre></div>
<p>クロージャ・ローカル宣言を終了します。  クロージャは xt によってスタック上に割り当てられるため、 クロージャの実行時のスタック効果は
<code>( xt-alloc -- xt-closure )</code> となります。
</p>

<span id="index-_003eaddr-_0028--xt-_002d_002d-addr--_0029-gforth_002dexperimental"></span>
<span id="index-_003eaddr"></span>
<span id="index-_003eaddr-1"></span>
<div class="format">
<pre class="format"><code>&gt;addr</code> ( <i>xt &ndash; addr  </i>) gforth-experimental &ldquo;to-addr&rdquo;
</pre></div>
<p>(<code>free-closure</code> から呼び出されます)ヒープ上のクロージャの xt を <var>addr</var> に変換し、 <code>free</code>
に渡すことでクロージャを削除できます。
</p>

<span id="index-free_002dclosure-_0028--xt-_002d_002d--_0029-gforth_002dinternal"></span>
<span id="index-free_002dclosure"></span>
<span id="index-free_002dclosure-1"></span>
<div class="format">
<pre class="format"><code>free-closure</code> ( <i>xt &ndash;  </i>) gforth-internal &ldquo;free-closure&rdquo;
</pre></div>
<p>ヒープに割り当てられたクロージャを解放(free)します
</p>


<div class="example">
<pre class="example">: foo [{: a f: b d: c xt: d :}d a . b f. c d. d ;] ;
5 3.3e #1234. ' cr foo execute
</pre></div>

<p>上記 <code>foo</code> は、 単一セルと浮動小数点数と2倍長整数と xt を含むクロージャをディクショナリ内に作成し、呼び出し時に最初の 3
つの値を出力後に xt を実行します。
</p>
<p>これにより、 Algol コンパイラーをテストするために 1964 年にドナルド・クヌースが提案した &ldquo;Man or boy test&rdquo;
を実装することができます(訳注: 手元ではサッパリ動いてない(0.7.9_20240418, 2024.7))
</p>
<div class="example">
<pre class="example">: A {: w^ k x1 x2 x3 xt: x4 xt: x5 | w^ B :} recursive
    k &nbsp;0&lt;= IF  x4 x5 f+  ELSE
        B k x1 x2 x3 action-of x4 [{: B k x1 x2 x3 x4 :}L
            -1 k +!
            k &nbsp;B &nbsp;x1 x2 x3 x4 A ;] dup B !
        execute  THEN ;
: man-or-boy? ( n -- ) [: 1e ;] [: -1e ;] 2dup swap [: 0e ;] A f. ;
</pre></div>

<p>場合によっては、 クロージャを変更するには永続的なストレージが必要です。 複数のクロージャがその永続ストレージを共有する可能性さえあります。
上の例では、 外部プロシージャのローカル変数がこれに使用されていますが、 場合によっては、 クロージャが外部プロシージャよりも長く存続します。 特に、
ディクショナリまたはヒープ上に割り当てられたクロージャは、 親プロシージャより長く存続するように設計されています。
</p>
<p>これらについては、 クロージャのように割り当てられるホーム・ロケーション(home locations)がありますが、
そのコードは作成時に直接実行され、 ホーム・ロケーションのアドレスを提供する必要があります。
</p>
<div class="example">
<pre class="example">: bar ( a b c -- aaddr baddr caddr hl-addr )
    &lt;{: w^ a w^ b w^ c :}h a b c ;&gt; ;
</pre></div>

<p>この例では、 ヒープ上に 3 つのセルを持つホーム・ロケーション(home location)を作成し、 3
つのロケーションのアドレスとホーム・ロケーションのアドレスを返します。  このアドレスは、 ホーム・ロケーションが不要になったときに
<code>free</code> するために使用できます。
</p>
<span id="index-_003c_007b_003a-_0028--_002d_002d-hmaddr-u-latest-latestnt-wid-0--_0029-gforth_002dexperimental"></span>
<span id="index-_003c_007b_003a"></span>
<span id="index-_003c_007b_003a-1"></span>
<div class="format">
<pre class="format"><code>&lt;{:</code> ( <i>&ndash; hmaddr u latest latestnt wid 0  </i>) gforth-experimental &ldquo;start-homelocation&rdquo;
</pre></div>
<p>ホーム・ロケーション(home location)の開始
</p>

<span id="index-_003b_003e-_0028--_002d_002d--_0029-gforth_002dexperimental"></span>
<span id="index-_003b_003e"></span>
<span id="index-_003b_003e-1"></span>
<div class="format">
<pre class="format"><code>;&gt;</code> ( <i>&ndash;  </i>) gforth-experimental &ldquo;end-homelocation&rdquo;
</pre></div>
<p>ホーム・ロケーションの終了
</p>


</div>
<hr>
<div class="header">
<p>
Previous: <a href="Locals-implementation.html">Locals implementation</a>, Up: <a href="Gforth-locals.html">Gforth locals</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Word-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
